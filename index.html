<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Di√°rio Miccional Digital</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Fonte Inter (padr√£o do Tailwind) */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none; /* Previne "pull-to-refresh" */
        }
        /* Esconde setas de input[type=number] */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #9ca3af; /* gray-400 */
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: #f3f4f6; /* gray-100 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 antialiased">

    <!-- Container Principal do App -->
    <div id="app" class="min-h-screen">

        <!-- TELA DE CARREGAMENTO INICIAL -->
        <div id="loading-screen" class="flex items-center justify-center min-h-screen p-4">
            <div class="text-center">
                <!-- Anima√ß√£o de Carregamento -->
                <svg class="animate-spin h-10 w-10 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4 text-lg font-medium text-gray-600">Carregando Di√°rio...</p>
            </div>
        </div>

        <!-- TELA INICIAL (Paciente vs Profissional) -->
        <div id="home-screen" class="hidden min-h-screen flex flex-col items-center justify-center p-6 bg-white">
            <div class="text-center max-w-lg w-full">
                
                <h1 class="text-3xl font-bold text-blue-700 mt-4">Di√°rio Miccional</h1>
                <p class="text-xl text-gray-600 mt-2 mb-10">Voc√™ √© Paciente ou Profissional de Sa√∫de?</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Emoji de paciente removido -->
                    <button id="btn-go-patient" class="flex flex-col items-center justify-center p-8 bg-blue-600 text-white rounded-lg shadow-lg hover:bg-blue-700 transition-all duration-300 transform hover:scale-105">
                        <span class="text-2xl font-semibold">Paciente</span>
                    </button>
                    <!-- Emoji de profissional removido -->
                    <button id="btn-go-prof" class="flex flex-col items-center justify-center p-8 bg-gray-700 text-white rounded-lg shadow-lg hover:bg-gray-800 transition-all duration-300 transform hover:scale-105">
                        <span class="text-2xl font-semibold">Profissional</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- TELA DE CADASTRO DO PACIENTE -->
        <div id="patient-register-screen" class="hidden min-h-screen flex items-center justify-center p-4">
            <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg">
                <h2 class="text-2xl font-bold text-center text-blue-700 mb-6">Cadastro do Paciente</h2>
                <form id="patient-register-form">
                    <div class="space-y-4">
                        <div>
                            <label for="reg-prontuario" class="block text-sm font-medium text-gray-700">N¬∫ Prontu√°rio</label>
                            <input type="text" id="reg-prontuario" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div>
                            <label for="reg-nome" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                            <input type="text" id="reg-nome" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div>
                            <label for="reg-idade" class="block text-sm font-medium text-gray-700">Idade</label>
                            <input type="number" id="reg-idade" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div>
                            <label for="reg-medicamentos" class="block text-sm font-medium text-gray-700">Medicamentos em Uso (separe por v√≠rgula)</label>
                            <textarea id="reg-medicamentos" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-300">
                            Salvar e Iniciar Di√°rio
                        </button>
                    </div>
                </form>
                <!-- Bot√£o "Voltar" adicionado -->
                <button id="btn-reg-back-to-home" class="mt-4 text-sm text-center w-full text-blue-600 hover:underline">Voltar</button>
            </div>
        </div>

        <!-- TELA DO DI√ÅRIO DO PACIENTE -->
        <div id="patient-diary-screen" class="hidden p-4 md:p-6 max-w-5xl mx-auto">
            <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
                <div>
                    <h1 class="text-3xl font-bold text-blue-700">Meu Di√°rio Miccional</h1>
                    <p id="patient-info" class="text-gray-600 mt-1">Carregando...</p>
                </div>
                <!-- Agrupando os bot√µes -->
                <div class="flex flex-col sm:flex-row sm:items-center gap-2 mt-4 sm:mt-0">
                    <button id="btn-add-day" class="w-full sm:w-auto bg-green-600 text-white py-2 px-5 rounded-lg font-semibold shadow-md hover:bg-green-700 transition-all duration-300">
                        + Adicionar Dia
                    </button>
                    <!-- BOT√ÉO DE SAIR ADICIONADO -->
                    <button id="btn-patient-logout" class="w-full sm:w-auto bg-red-600 text-white py-2 px-5 rounded-lg font-semibold shadow-md hover:bg-red-700 transition-all duration-300">
                        Sair
                    </button>
                </div>
            </header>
            
            <!-- Container dos dias -->
            <div id="days-container" class="space-y-8">
                <!-- Dias ser√£o injetados aqui pelo JS -->
                <p class="text-center text-gray-500">Nenhum dia registrado ainda. Clique em "Adicionar Dia" para come√ßar.</p>
            </div>
            
            <!-- Formul√°rios de Modal (escondidos) -->
            <div id="form-templates" class="hidden">
                <!-- Formul√°rio de Entrada (Ingest√£o) -->
                <form id="intake-form-template" class="space-y-4">
                    <input type="hidden" name="dayId">
                    <input type="hidden" name="entryId"> <!-- Para edi√ß√£o -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Data e Hora</label>
                        <input type="datetime-local" name="datetime" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Tipo</label>
                        <select name="type" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" onchange="this.form.querySelector('#intake-details').style.display = (this.value === 'liquido' ? 'block' : 'none'); this.form.querySelector('#fruit-details').style.display = (this.value === 'fruta' ? 'block' : 'none');">
                            <option value="liquido">L√≠quido</option>
                            <option value="fruta">Fruta</option>
                        </select>
                    </div>
                    <div id="intake-details">
                        <label class="block text-sm font-medium text-gray-700">Volume (ml)</label>
                        <input type="number" name="volume" placeholder="Ex: 200" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div id="fruit-details" style="display: none;">
                        <label class="block text-sm font-medium text-gray-700">Nome da Fruta</label>
                        <input type="text" name="fruitName" placeholder="Ex: Melancia" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                </form>
                
                <!-- Formul√°rio de Sa√≠da (Mic√ß√£o) -->
                <form id="output-form-template" class="space-y-4">
                    <input type="hidden" name="dayId">
                    <input type="hidden" name="entryId"> <!-- Para edi√ß√£o -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Data e Hora</label>
                        <input type="datetime-local" name="datetime" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700">Volume Urinado (ml)</label>
                            <!-- L√≥gica oninput melhorada -->
                            <input type="number" name="volume" placeholder="Ex: 150" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" oninput="this.form.querySelector('select[name=nonQuantifiable]').value = ''; this.form.querySelector('select[name=nonQuantifiable]').disabled = !!this.value;">
                        </div>
                        <span class="mt-6 text-gray-500">OU</span>
                        <div class="flex-1" id="non-quantifiable-group">
                            <label class="block text-sm font-medium text-gray-700">N√£o Quantific√°vel</label>
                            <select name="nonQuantifiable" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" onchange="this.form.querySelector('input[name=volume]').disabled = (this.value !== ''); this.form.querySelector('input[name=volume]').value = '';">
                                <option value="">Nenhum</option>
                                <option value="+">+</option>
                                <option value="++">++</option>
                                <option value="+++">+++</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Local</label>
                        <select name="location" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" required>
                            <option value="Banheiro">Banheiro</option>
                            <option value="Fralda">Fralda</option>
                            <option value="Coletor">Coletor</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Volume Residual (Bladder, ml)</label>
                        <input type="number" name="residual" placeholder="Ex: 20" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                </form>
            </div>
        </div>
        
        <!-- TELA DE LOGIN PROFISSIONAL -->
        <div id="prof-login-screen" class="hidden min-h-screen flex items-center justify-center p-4 bg-gray-900">
            <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md text-center">
                <span class="text-7xl">üßë‚Äç‚öïÔ∏è</span> <!-- Emoji mantido aqui pois n√£o estava na tela inicial -->
                <h2 class="text-2xl font-bold text-center text-gray-800 mt-4 mb-2">√Årea do Profissional</h2>
                <p class="text-gray-600 mb-6">Acesso restrito.</p>
                <form id="prof-login-form">
                    <div class="space-y-4">
                        <div>
                            <label for="login-email" class="block text-sm font-medium text-gray-700 text-left">Email</label>
                            <input type="email" id="login-email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div>
                            <label for="login-password" class="block text-sm font-medium text-gray-700 text-left">Senha</label>
                            <input type="password" id="login-password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <button type="submit" id="btn-login-submit" class="w-full bg-gray-700 text-white py-3 px-4 rounded-lg font-semibold shadow-md hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-all duration-300 disabled:opacity-50">
                            Entrar
                        </button>
                        <p id="login-error" class="text-red-600 text-sm hidden"></p>
                    </div>
                </form>
                <!-- Este bot√£o "Voltar" j√° existia e est√° correto -->
                <button id="btn-back-to-home" class="mt-4 text-sm text-blue-600 hover:underline">Voltar</button>
            </div>
        </div>

        <!-- TELA DO PAINEL PROFISSIONAL -->
        <div id="prof-dashboard-screen" class="hidden p-4 md:p-6 max-w-7xl mx-auto">
            <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
                <h1 class="text-3xl font-bold text-gray-800">Painel Profissional</h1>
                <div id="prof-info" class="text-right">
                    <p class="text-gray-600">Carregando...</p>
                    <button id="btn-prof-logout" class="text-sm text-red-600 hover:underline">Sair</button>
                </div>
            </header>

            <!-- Barra de Busca -->
            <div class="bg-white p-4 rounded-xl shadow-md mb-6">
                <form id="patient-search-form" class="flex flex-col sm:flex-row gap-3">
                    <label for="search-prontuario" class="font-medium flex-shrink-0 py-2">Buscar por Prontu√°rio:</label>
                    <input type="text" id="search-prontuario" class="flex-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                    <button type="submit" class="w-full sm:w-auto bg-blue-600 text-white py-2 px-5 rounded-lg font-semibold shadow-md hover:bg-blue-700 transition-all duration-300">
                        Buscar
                    </button>
                </form>
                <p id="search-status" class="text-sm mt-2"></p>
            </div>

            <!-- √Årea de Dados do Paciente -->
            <div id="patient-data-container" class="hidden">
                <!-- Informa√ß√µes do Paciente -->
                <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                    <div class="flex justify-between items-start">
                        <h2 class="text-2xl font-bold text-blue-700 mb-4">Dados do Paciente</h2>
                        <!-- Bot√£o PDF Retirado -->
                    </div>
                    <!-- Este container agora mostra o perfil do *primeiro* paciente encontrado -->
                    <div id="prof-patient-profile" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700">
                        <!-- Dados do perfil do paciente aqui -->
                    </div>
                </div>

                <!-- Di√°rio do Paciente (vis√£o do prof) -->
                <!-- Este container agora agrupa *m√∫ltiplas* sess√µes -->
                <h3 class="text-xl font-semibold text-gray-700 mb-4">Di√°rio Consolidado</h3>
                <div id="prof-days-container" class="space-y-8">
                    <!-- Dias do paciente carregados aqui -->
                </div>
            </div>

        </div>

        <!-- MODAL GEN√âRICO (Confirma√ß√£o, Alerta) -->
        <div id="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
            <!-- Overlay -->
            <div id="modal-overlay" class="absolute inset-0 bg-black opacity-60"></div>
            
            <!-- Conte√∫do do Modal -->
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm z-10">
                <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4"></h3>
                <div id="modal-body" class="text-gray-600 mb-6">
                    <!-- Conte√∫do din√¢mico (texto ou elemento HTML) -->
                </div>
                <div class="flex justify-end space-x-3">
                    <button id="modal-btn-cancel" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg font-medium hover:bg-gray-300">
                        Cancelar
                    </button>
                    <button id="modal-btn-confirm" class="text-white py-2 px-4 rounded-lg font-semibold shadow-md">
                        Confirmar
                    </button>
                </div>
            </div>
        </div>

    </div> <!-- Fim do #app -->


    <!-- =========================================================================================== -->
    <!-- SCRIPT PRINCIPAL DO APP (inclui l√≥gica do Firebase)                                        -->
    <!-- =========================================================================================== -->
    <script type="module">
        // Importa√ß√µes do Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            signInWithEmailAndPassword,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            getDocs,
            addDoc,
            updateDoc,
            arrayUnion,
            arrayRemove,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Vari√°veis Globais do App ---
        let app, db, auth;
        let userId = null; // UID do Firebase (paciente ou profissional)
        let isProfessional = false;
        // MUDAN√áA: N√£o usamos mais 'onSnapshot' para o profissional, ent√£o o array foi removido.
        let currentPatientDiaryUnsubscribe = null; // Listener do di√°rio (vis√£o do paciente)

        // Configura√ß√£o do Firebase (puxada do ambiente)
        const appId = 'diario-miccional-1'; // Usei seu Project ID
        
        // (Atualizado com os dados que voc√™ forneceu)
        const firebaseConfig = {
            apiKey: "AIzaSyCZRKyT20a_jdD9oZWCq9iy9nTxER5pGWg",
            authDomain: "diario-miccional-1.firebaseapp.com",
            projectId: "diario-miccional-1",
            storageBucket: "diario-miccional-1.firebasestorage.app",
            messagingSenderId: "427993247976",
            appId: "1:427993247976:web:ef1c82c8a1d7db3ed3595d"
        };


        // --- Seletores de DOM ---
        const screens = {
            loading: document.getElementById('loading-screen'),
            home: document.getElementById('home-screen'),
            patientRegister: document.getElementById('patient-register-screen'),
            patientDiary: document.getElementById('patient-diary-screen'),
            profLogin: document.getElementById('prof-login-screen'),
            profDashboard: document.getElementById('prof-dashboard-screen'),
        };
        
        const modal = document.getElementById('modal');
        const modalOverlay = document.getElementById('modal-overlay');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalBtnCancel = document.getElementById('modal-btn-cancel');
        const modalBtnConfirm = document.getElementById('modal-btn-confirm');
        
        // --- Fun√ß√µes Utilit√°rias ---

        /**
         * Mostra uma tela e esconde as outras
         * @param {string} screenId ID da tela para mostrar (ex: 'home')
         */
        function showScreen(screenId) {
            Object.values(screens).forEach(screen => screen.classList.add('hidden'));
            if (screens[screenId]) {
                screens[screenId].classList.remove('hidden');
            } else {
                console.error(`Tela "${screenId}" n√£o encontrada.`);
            }
        }

        /**
         * Sanitiza (escapa) o input do usu√°rio para prevenir XSS
         * @param {string} str String de entrada
         * @returns {string} String escapada
         */
        function sanitize(str) {
            if (!str) return "";
            const temp = document.createElement('div');
            temp.textContent = str; // Converte <, >, & etc. para &lt;, &gt;, &amp;
            return temp.innerHTML; // Retorna a string escapada
        }
        
        /**
         * Formata data e hora ISO para um formato local (YYYY-MM-DDTHH:MM)
         */
        function formatDateTimeLocal(isoString) {
            if (!isoString) return "";
            const date = new Date(isoString);
            // Ajusta para o fuso hor√°rio local
            date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
            return date.toISOString().slice(0, 16);
        }

        /**
         * Formata data e hora ISO para um formato leg√≠vel (dd/mm/aaaa hh:mm)
         */
        function formatDateTimeReadable(isoString) {
            if (!isoString) return "N/A";
            const date = new Date(isoString);
            return date.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        /**
         * Pega a data e hora local atual no formato YYYY-MM-DDTHH:MM
         */
        function getCurrentDateTimeLocal() {
            return formatDateTimeLocal(new Date().toISOString());
        }

        /**
         * Mostra o Modal gen√©rico
         * @param {string} title T√≠tulo do modal
         * @param {string|HTMLElement} body Conte√∫do (texto ou elemento HTML)
         * @param {object} options Op√ß√µes (confirmText, cancelText, confirmColor, onConfirm)
         */
        function showModal(title, body, options = {}) {
            const {
                confirmText = 'Confirmar',
                cancelText = 'Cancelar',
                confirmColor = 'bg-blue-600',
                onConfirm = () => {},
                onCancel = () => hideModal()
            } = options;

            modalTitle.textContent = title;
            
            if (typeof body === 'string') {
                modalBody.innerHTML = '';
                const p = document.createElement('p');
                p.textContent = body;
                modalBody.appendChild(p);
            } else if (body instanceof HTMLElement) {
                modalBody.innerHTML = ''; // Limpa o corpo
                modalBody.appendChild(body);
            }

            modalBtnConfirm.textContent = confirmText;
            modalBtnConfirm.className = `text-white py-2 px-4 rounded-lg font-semibold shadow-md ${confirmColor} hover:opacity-90`;
            
            modalBtnCancel.textContent = cancelText;
            modalBtnCancel.style.display = cancelText ? 'inline-block' : 'none';

            // Remove listeners antigos e adiciona novos
            modalBtnConfirm.onclick = () => {
                onConfirm();
                // N√£o esconder automaticamente, a fun√ß√£o onConfirm pode querer validar
            };
            modalBtnCancel.onclick = onCancel;
            modalOverlay.onclick = onCancel;
            
            modal.classList.remove('hidden');
        }

        /** Esconde o modal */
        function hideModal() {
            modal.classList.add('hidden');
            // Limpa o corpo do modal para evitar que formul√°rios persistam
            modalBody.innerHTML = '';
        }

        // --- Fun√ß√µes de Inicializa√ß√£o e Autentica√ß√£o ---

        /**
         * Inicializa o Firebase e configura o listener de autentica√ß√£o
         */
        async function initializeFirebase() {
            try {
                // Valida√ß√£o de configura√ß√£o
                if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                    throw new Error("Configura√ß√£o do Firebase n√£o encontrada. Verifique as vari√°veis de ambiente.");
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); // Para debug no console

                // Listener principal de autentica√ß√£o
                onAuthStateChanged(auth, async (user) => {
                    try {
                        if (user) {
                            // Usu√°rio est√° logado
                            userId = user.uid;
                            
                            // *** L√ìGICA DE VERIFICA√á√ÉO (MAIS F√ÅCIL) ***
                            
                            // Esta verifica√ß√£o s√≥ acontece se o usu√°rio N√ÉO for an√¥nimo
                            if (!user.isAnonymous) {
                                const adminDocRef = doc(db, "administradores", user.uid);
                                const adminDocSnap = await getDoc(adminDocRef);

                                if (adminDocSnap.exists()) {
                                    isProfessional = true;
                                } else {
                                    // Se n√£o est√° na lista de admin, n√£o √© profissional
                                    isProfessional = false;
                                }
                            } else {
                                // Se √© an√¥nimo, √© paciente
                                isProfessional = false;
                            }
                            
                            // Agora, o resto da l√≥gica
                            if (isProfessional) {
                                // √â PROFISSIONAL
                                console.log("Usu√°rio √© Profissional");
                                document.getElementById('prof-info').innerHTML = `
                                    <p class="text-gray-600 text-sm">${sanitize(user.email)}</p>
                                    <button id="btn-prof-logout" class="text-sm text-red-600 hover:underline">Sair</button>
                                `;
                                document.getElementById('btn-prof-logout').onclick = handleProfLogout;
                                showScreen('profDashboard');
                            } else {
                                // √â PACIENTE (ou profissional que ainda n√£o se promoveu)
                                console.log("Usu√°rio √© Paciente");
                                isProfessional = false; 
                                await checkPatientRegistration();
                            }
                        } else {
                            // Ningu√©m logado, mostrar tela inicial
                            userId = null;
                            isProfessional = false;
                            showScreen('home');
                        }
                    } catch (error) {
                        console.error("Erro no listener de autentica√ß√£o (onAuthStateChanged):", error);
                        // Se algo der errado (ex: falha de rede ao checar admin),
                        // envia o usu√°rio para a tela inicial para evitar que fique preso.
                        showScreen('home');
                        showModal("Erro de Autentica√ß√£o", "Ocorreu um erro ao verificar sua sess√£o. Por favor, tente novamente.", { confirmText: "OK", cancelText: null });
                    }
                });

            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                document.getElementById('loading-screen').innerHTML = `<p class='text-red-600 p-4 text-center'><b>Erro ao carregar o aplicativo.</b><br>${error.message}</p>`;
            }
        }
        
        /**
         * Faz o login do paciente (an√¥nimo ou com token)
         */
        async function signInPatient() {
            try {
                // Se um profissional estiver logado, faz logout primeiro
                if (auth.currentUser && !auth.currentUser.isAnonymous) {
                    console.log("Profissional logado. A fazer logout...");
                    await signOut(auth);
                    // O onAuthStateChanged vai detetar o logout, e depois o login an√¥nimo.
                    await signInAnonymously(auth);
                    return; // Deixa o listener tratar do resto
                }
                
                showScreen('loading');

                // CORRE√á√ÉO: Se j√° for an√¥nimo, n√£o faz login de novo.
                // Apenas executa a verifica√ß√£o de registo.
                if (auth.currentUser && auth.currentUser.isAnonymous) {
                    console.log("Usu√°rio j√° √© an√¥nimo. Verificando cadastro...");
                    await checkPatientRegistration(); // Apenas roda a verifica√ß√£o
                    return; // Termina aqui, pois n√£o h√° mudan√ßa de auth
                }

                // Se n√£o tem usu√°rio, loga anonimamente
                if (!auth.currentUser) {
                    console.log("Nenhum usu√°rio. A fazer login an√¥nimo...");
                    await signInAnonymously(auth);
                    // onAuthStateChanged vai lidar com o resto
                    return;
                }

                // Fallback para token (se existir)
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                     await signInWithCustomToken(auth, __initial_auth_token);
                     // onAuthStateChanged vai lidar com o resto
                }
                
            } catch (error) {
                console.error("Erro no login do paciente:", error);
                showScreen('home');
                showModal("Erro de Login", "N√£o foi poss√≠vel iniciar a sess√£o. Tente novamente.", { confirmText: "OK", cancelText: null });
            }
        }
        
        /**
         * Verifica se o paciente j√° tem cadastro
         */
        async function checkPatientRegistration() {
            if (!userId) return;
            
            showScreen('loading');
            try {
                // Esta l√≥gica est√° correta. A sess√£o an√¥nima (userId) √© o "dono" do perfil.
                // Se o usu√°rio faz logout, um novo userId √© gerado, e ele n√£o
                // encontrar√° este perfil, indo para o registo (comportamento "zerado").
                const profileDocRef = doc(db, "artifacts", appId, "users", userId, "patientProfile", "profile");
                const docSnap = await getDoc(profileDocRef);

                if (docSnap.exists()) {
                    // Paciente cadastrado, vai para o di√°rio
                    loadPatientDiary(userId);
                    showScreen('patientDiary');
                } else {
                    // Novo paciente, vai para o cadastro
                    showScreen('patientRegister');
                }
            } catch (error) {
                console.error("Erro ao verificar cadastro:", error);
                showScreen('home');
            }
        }
        
        // --- Fluxo do Paciente ---
        
        /**
         * Lida com o registro do paciente
         */
        async function handlePatientRegister(event) {
            event.preventDefault();
            const prontuario = sanitize(document.getElementById('reg-prontuario').value);
            const nome = sanitize(document.getElementById('reg-nome').value);
            const idade = sanitize(document.getElementById('reg-idade').value);
            const medicamentos = sanitize(document.getElementById('reg-medicamentos').value);

            if (!prontuario || !nome || !idade) {
                showModal("Campos Obrigat√≥rios", "Por favor, preencha Prontu√°rio, Nome e Idade.", { confirmText: "OK", cancelText: null });
                return;
            }
            
            const patientData = {
                medicalRecord: prontuario,
                name: nome,
                age: parseInt(idade),
                medications: medicamentos,
                createdAt: new Date().toISOString()
            };

            // O √≠ndice √© a chave para o profissional encontrar os dados
            const indexData = {
                medicalRecord: prontuario,
                patientUserId: userId, // O ID an√¥nimo desta sess√£o
                patientName: nome,
                createdAt: new Date().toISOString() // Adicionado para ordena√ß√£o
            };
            
            showScreen('loading');
            try {
                // Salva o perfil privado (ligado ao userId an√¥nimo)
                const profileDocRef = doc(db, "artifacts", appId, "users", userId, "patientProfile", "profile");
                await setDoc(profileDocRef, patientData);
                
                // Cria o √≠ndice p√∫blico para busca do profissional
                // Usamos o userId como ID do documento de √≠ndice
                const indexDocRef = doc(db, "artifacts", appId, "public/data/patientIndex", userId);
                await setDoc(indexDocRef, indexData);

                // Vai para o di√°rio
                loadPatientDiary(userId);
                showScreen('patientDiary');
                
            } catch (error) {
                console.error("Erro ao salvar cadastro:", error);
                showModal("Erro no Cadastro", "Erro ao salvar cadastro. Tente novamente.", { confirmText: "OK", cancelText: null });
                showScreen('patientRegister');
            }
        }

        /**
         * Carrega o di√°rio do paciente (com listener real-time)
         * @param {string} patientUserId ID do paciente
         */
        function loadPatientDiary(patientUserId) {
            // Atualiza o header do paciente
            const patientInfo = document.getElementById('patient-info');
            const profileDocRef = doc(db, "artifacts", appId, "users", patientUserId, "patientProfile", "profile");
            
            // Listener para o perfil (caso mude)
            onSnapshot(profileDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    patientInfo.textContent = `${data.name} (Prontu√°rio: ${data.medicalRecord})`;
                } else {
                     patientInfo.textContent = "Paciente n√£o encontrado.";
                }
            }, (error) => {
                console.error("Erro ao carregar perfil do paciente:", error);
                patientInfo.textContent = "Erro ao carregar perfil.";
            });


            // Limpa listener antigo do di√°rio, se houver
            if (currentPatientDiaryUnsubscribe) {
                currentPatientDiaryUnsubscribe();
            }

            // Ouve a cole√ß√£o de dias
            const daysCollectionRef = collection(db, "artifacts", appId, "users", patientUserId, "diaryDays");
            const q = query(daysCollectionRef);
            
            currentPatientDiaryUnsubscribe = onSnapshot(q, (querySnapshot) => {
                const days = [];
                querySnapshot.forEach((doc) => {
                    days.push({ id: doc.id, ...doc.data() });
                });
                // Ordena no cliente para evitar complexidade de √≠ndice no Firestore
                days.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                renderPatientDiary(days);
                
            }, (error) => {
                console.error("Erro ao carregar di√°rio:", error);
                document.getElementById('days-container').innerHTML = '<p class="text-red-600">Erro ao carregar di√°rio.</p>';
            });
        }
        
        /**
         * Renderiza os cart√µes dos dias na tela do paciente
         * @param {Array} days Array de objetos de dia
         */
        function renderPatientDiary(days) {
            const container = document.getElementById('days-container');
            if (days.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">Nenhum dia registrado ainda. Clique em "Adicionar Dia" para come√ßar.</p>';
                return;
            }
            
            container.innerHTML = ''; // Limpa o container
            days.forEach(day => {
                const dayCard = createDayCard(day, 'patient');
                container.appendChild(dayCard);
            });
        }

        /**
         * Cria e retorna um elemento HTML para um cart√£o de dia
         * @param {object} day Objeto do dia
         * @param {string} view 'patient' ou 'prof'
         * @param {Array|null} [sessions=null] Array de sess√µes (para vis√£o do prof)
         */
        function createDayCard(day, view = 'patient') {
            const dayCard = document.createElement('div');
            dayCard.className = 'bg-white p-4 md:p-6 rounded-xl shadow-lg';
            dayCard.dataset.dayId = day.id; // day.id √© a data YYYY-MM-DD

            // 'day' j√° cont√©m os dados agrupados (intake/output)
            const calculations = calculateDayStats(day);
            const readableDate = new Date(day.date + 'T00:00:00').toLocaleDateString('pt-BR', { timeZone: 'UTC', day: '2-digit', month: '2-digit', year: 'numeric' });

            let highlightsHTML = '';
            calculations.highlights.forEach(h => {
                const color = h.level === 'danger' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800';
                highlightsHTML += `<li class="px-2 py-1 ${color} rounded-md text-sm">${h.message}</li>`;
            });

            // Ordena entradas e sa√≠das por data/hora
            // (Isto √© importante pois agora v√™m de m√∫ltiplas sess√µes)
            const sortedIntake = [...day.intake].sort((a, b) => new Date(a.datetime) - new Date(b.datetime));
            const sortedOutput = [...day.output].sort((a, b) => new Date(a.datetime) - new Date(b.datetime));

            // CORRE√á√ÉO: Cria o cabe√ßalho de sess√£o agrupada
            const isMerged = view === 'prof' && day.sessions && day.sessions.length > 0;
            let sessionHeader = '';
            if (isMerged) {
                sessionHeader = `
                   <div class="mb-2 p-2 bg-gray-100 rounded-md border border-gray-200">
                     <p class="text-sm font-semibold text-gray-700">Dados combinados de ${day.sessions.length} sess√µes:</p>
                     <ul class="list-disc list-inside text-xs text-gray-500 mt-1">
                       ${day.sessions.map(s => `<li>Sess√£o de ${formatDateTimeReadable(s.createdAt)} (ID: ...${s.patientUserId.slice(-5)})</li>`).join('')}
                     </ul>
                   </div>`;
            }

            dayCard.innerHTML = `
                ${sessionHeader}
                <!-- Header do Cart√£o -->
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 pb-4 border-b">
                    <h3 class="text-2xl font-bold text-blue-600">${readableDate}</h3>
                    ${view === 'patient' ? `
                    <div class="flex space-x-2 mt-3 sm:mt-0">
                        <button class="btn-add-intake bg-blue-500 text-white py-2 px-4 rounded-lg font-semibold text-sm hover:bg-blue-600">+ Entrada</button>
                        <button class="btn-add-output bg-orange-500 text-white py-2 px-4 rounded-lg font-semibold text-sm hover:bg-orange-600">+ Sa√≠da</button>
                        <!-- Bot√£o PDF Retirado -->
                    </div>
                    ` : `
                    <div class="flex space-x-2 mt-3 sm:mt-0">
                        <!-- Bot√£o PDF Retirado -->
                    </div>
                    `}
                </div>

                <!-- Estat√≠sticas -->
                <div class="mb-6">
                    <h4 class="text-lg font-semibold mb-3 text-gray-700">Resumo do Dia (Consolidado)</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-blue-50 p-3 rounded-lg text-center">
                            <span class="block text-sm text-blue-800 font-medium">Entradas</span>
                            <span class="block text-xl font-bold text-blue-900">${calculations.totalIntake} ml</span>
                        </div>
                        <div class="bg-orange-50 p-3 rounded-lg text-center">
                            <span class="block text-sm text-orange-800 font-medium">Sa√≠das</span>
                            <span class="block text-xl font-bold text-orange-900">${calculations.totalOutput} ml</span>
                        </div>
                        <div class="bg-gray-100 p-3 rounded-lg text-center">
                            <span class="block text-sm text-gray-800 font-medium">Balan√ßo</span>
                            <span class="block text-xl font-bold ${calculations.balance >= 0 ? 'text-green-700' : 'text-red-700'}">${calculations.balance} ml</span>
                        </div>
                        <div class="bg-indigo-50 p-3 rounded-lg text-center">
                            <span class="block text-sm text-indigo-800 font-medium">Vol. Urin√°rio Noturno</span>
                            <span class="block text-xl font-bold text-indigo-900">${calculations.nightlyVolume} ml</span>
                        </div>
                    </div>
                    ${highlightsHTML ? `<ul class="mt-4 space-y-1">${highlightsHTML}</ul>` : ''}
                </div>

                <!-- Listas de Entradas e Sa√≠das -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Entradas -->
                    <div>
                        <h4 class="text-lg font-semibold mb-3 text-blue-700">Entradas (Consolidado)</h4>
                        <ul id="intake-list-${day.id}" class="space-y-2">
                            ${sortedIntake.length === 0 ? '<li class="text-gray-500 text-sm">Nenhuma entrada registrada.</li>' : ''}
                            ${sortedIntake.map(entry => createEntryItem(entry, 'intake', day.id, view)).join('')}
                        </ul>
                    </div>
                    <!-- Sa√≠das -->
                    <div>
                        <h4 class="text-lg font-semibold mb-3 text-orange-700">Sa√≠das (Consolidado)</h4>
                        <ul id="output-list-${day.id}" class="space-y-2">
                            ${sortedOutput.length === 0 ? '<li class="text-gray-500 text-sm">Nenhuma sa√≠da registrada.</li>' : ''}
                            ${sortedOutput.map(entry => createEntryItem(entry, 'output', day.id, view)).join('')}
                        </ul>
                    </div>
                </div>
            `;
            
            if (view === 'patient') {
                dayCard.querySelector('.btn-add-intake').onclick = () => showEntryModal('intake', day.id);
                dayCard.querySelector('.btn-add-output').onclick = () => showEntryModal('output', day.id);
                
                // Adiciona listeners para bot√µes de deletar/editar
                dayCard.querySelectorAll('.btn-edit-entry').forEach(btn => {
                    btn.onclick = (e) => {
                        const { dayId, entryType, entryId } = e.currentTarget.dataset;
                        // Na vis√£o do paciente, 'day' √© o objeto original (n√£o agrupado)
                        const entry = day[entryType].find(item => item.id === entryId);
                        showEntryModal(entryType, dayId, entry);
                    };
                });
                dayCard.querySelectorAll('.btn-delete-entry').forEach(btn => {
                    btn.onclick = (e) => {
                        const { dayId, entryType, entryId } = e.currentTarget.dataset;
                        handleDeleteEntry(dayId, entryType, entryId);
                    };
                });
            } else {
                 // Na vis√£o do profissional, n√£o h√° edi√ß√£o/delete
            }

            return dayCard;
        }
        
        /**
         * Cria o HTML para um item da lista (entrada ou sa√≠da)
         * @param {object} entry Objeto da entrada/sa√≠da
         * @param {string} type 'intake' ou 'output'
         * @param {string} dayId ID do dia (data)
         * @param {string} view 'patient' ou 'prof'
         */
        function createEntryItem(entry, type, dayId, view) {
            let details = '';
            if (type === 'intake') {
                details = entry.type === 'liquido'
                    ? `${entry.volume} ml`
                    : `Fruta (${sanitize(entry.fruitName)})`;
            } else { // output
                const volume = entry.volume ? `${entry.volume} ml` : `N√£o quant. (${entry.nonQuantifiable})`;
                const residual = entry.residual ? ` (Res: ${entry.residual} ml)` : '';
                const residualColor = entry.residual > 100 ? 'text-red-600' : (entry.residual > 30 ? 'text-yellow-600' : '');
                details = `${volume} no ${entry.location}<span class="font-medium ${residualColor}">${residual}</span>`;
            }

            return `
                <li class="flex items-start justify-between p-2.5 bg-gray-50 rounded-lg" data-id="${entry.id}">
                    <div>
                        <span class="block font-medium text-gray-800">${formatDateTimeReadable(entry.datetime)}</span>
                        <span class="block text-sm text-gray-600">${details}</span>
                    </div>
                    ${view === 'patient' ? `
                    <div class="flex space-x-1 flex-shrink-0 ml-2">
                        <button class="btn-edit-entry" data-day-id="${dayId}" data-entry-type="${type}" data-entry-id="${entry.id}" aria-label="Editar">
                            <svg class="w-5 h-5 text-gray-400 hover:text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                        </button>
                        <button class="btn-delete-entry" data-day-id="${dayId}" data-entry-type="${type}" data-entry-id="${entry.id}" aria-label="Apagar">
                            <svg class="w-5 h-5 text-gray-400 hover:text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                    ` : ''}
                </li>
            `;
        }

        /**
         * Adiciona um novo dia ao di√°rio
         */
        async function handleAddDay() {
            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
            const dayId = today; // Usamos a data como ID do documento

            if (!userId) return;

            const dayDocRef = doc(db, "artifacts", appId, "users", userId, "diaryDays", dayId);
            const docSnap = await getDoc(dayDocRef);

            if (docSnap.exists()) {
                showModal("Dia J√° Existe", "O dia de hoje j√° foi adicionado.", { confirmText: "OK", cancelText: null });
                return;
            }

            try {
                const newDay = {
                    date: today,
                    intake: [],
                    output: [],
                    createdAt: new Date().toISOString()
                };
                await setDoc(dayDocRef, newDay);
                // O listener onSnapshot vai atualizar a UI
            } catch (error) {
                console.error("Erro ao adicionar dia:", error);
                showModal("Erro", "Erro ao adicionar o dia. Tente novamente.", { confirmText: "OK", cancelText: null });
            }
        }

        /**
         * Mostra o modal para adicionar/editar uma entrada ou sa√≠da
         * @param {string} type 'intake' ou 'output'
         * @param {string} dayId ID do dia (data)
         * @param {object|null} entryToEdit Objeto da entrada para editar (null se for novo)
         */
        function showEntryModal(type, dayId, entryToEdit = null) {
            const isEditing = !!entryToEdit;
            const title = `${isEditing ? 'Editar' : 'Adicionar'} ${type === 'intake' ? 'Entrada' : 'Sa√≠da'}`;
            
            // Clona o formul√°rio do template
            const formTemplate = document.getElementById(type === 'intake' ? 'intake-form-template' : 'output-form-template');
            const form = formTemplate.cloneNode(true);
            form.id = `modal-${type}-form`;
            
            // Preenche os campos do formul√°rio
            form.dayId.value = dayId;
            
            if (isEditing) {
                form.entryId.value = entryToEdit.id;
                form.datetime.value = formatDateTimeLocal(entryToEdit.datetime);
                if (type === 'intake') {
                    form.type.value = entryToEdit.type;
                    form.volume.value = entryToEdit.volume || '';
                    form.fruitName.value = entryToEdit.fruitName || '';
                } else { // output
                    form.volume.value = entryToEdit.volume || '';
                    form.nonQuantifiable.value = entryToEdit.nonQuantifiable || '';
                    form.location.value = entryToEdit.location;
                    form.residual.value = entryToEdit.residual || '';
                }
            } else {
                form.datetime.value = getCurrentDateTimeLocal();
            }
            
            // Ajusta visibilidade dos campos com base nos valores
            if (type === 'intake') {
                const intakeDetails = form.querySelector('#intake-details');
                const fruitDetails = form.querySelector('#fruit-details');
                const typeSelect = form.querySelector('select[name="type"]');
                intakeDetails.style.display = (typeSelect.value === 'liquido' ? 'block' : 'none');
                fruitDetails.style.display = (typeSelect.value === 'fruta' ? 'block' : 'none');
            } else { // output
                const volumeInput = form.querySelector('input[name="volume"]');
                const nonQuantifiableGroup = form.querySelector('#non-quantifiable-group');
                const nonQuantifiableSelect = form.querySelector('select[name="nonQuantifiable"]');
                
                nonQuantifiableGroup.style.display = (volumeInput.value ? 'none' : 'block');
                volumeInput.disabled = (nonQuantifiableSelect.value !== '');
                nonQuantifiableSelect.disabled = (volumeInput.value !== '');
            }

            // Mostra o modal com o formul√°rio
            showModal(title, form, {
                confirmText: 'Salvar',
                confirmColor: 'bg-green-600',
                onConfirm: () => {
                    handleSubmitEntry(form, type, dayId, isEditing);
                }
            });
        }
        
        /**
         * Lida com o submit do formul√°rio de entrada/sa√≠da
         */
        async function handleSubmitEntry(form, type, dayId, isEditing) {
            const formData = new FormData(form);
            const entryId = isEditing ? form.entryId.value : crypto.randomUUID();
            
            let entryData;
            
            if (type === 'intake') {
                const intakeType = formData.get('type');
                entryData = {
                    id: entryId,
                    datetime: new Date(formData.get('datetime')).toISOString(),
                    type: intakeType,
                    volume: intakeType === 'liquido' ? parseInt(sanitize(formData.get('volume'))) || 0 : 0,
                    fruitName: intakeType === 'fruta' ? sanitize(formData.get('fruitName')) : ''
                };
            } else { // output
                entryData = {
                    id: entryId,
                    datetime: new Date(formData.get('datetime')).toISOString(),
                    volume: parseInt(sanitize(formData.get('volume'))) || 0,
                    nonQuantifiable: sanitize(formData.get('nonQuantifiable')) || '',
                    location: sanitize(formData.get('location')),
                    residual: parseInt(sanitize(formData.get('residual'))) || 0
                };
            }
            
            const dayDocRef = doc(db, "artifacts", appId, "users", userId, "diaryDays", dayId);

            try {
                if (isEditing) {
                    // L√ìGICA DE EDI√á√ÉO (Get -> Modify -> Set)
                    const docSnap = await getDoc(dayDocRef);
                    if (!docSnap.exists()) throw new Error("Documento do dia n√£o encontrado.");

                    const dayData = docSnap.data();
                    const entriesArray = dayData[type] || [];
                    
                    const index = entriesArray.findIndex(e => e.id === entryId);
                    
                    if (index > -1) {
                        entriesArray[index] = entryData; // Substitui o item
                    } else {
                        entriesArray.push(entryData); // Adiciona se n√£o achou (fallback)
                    }

                    // Salva o array inteiro de volta
                    await updateDoc(dayDocRef, {
                        [type]: entriesArray
                    });

                } else {
                    // L√ìGICA DE ADI√á√ÉO (Atomic ArrayUnion)
                    await updateDoc(dayDocRef, {
                        [type]: arrayUnion(entryData)
                    });
                }
                
                hideModal(); // Sucesso
            } catch (error) {
                console.error("Erro ao salvar registro:", error);
                showModal("Erro", "Erro ao salvar. Tente novamente.", { confirmText: "OK", cancelText: null });
            }
        }
        
        /**
         * Deleta um registro de entrada ou sa√≠da
         */
        function handleDeleteEntry(dayId, entryType, entryId) {
            showModal(
                'Apagar Registro',
                'Voc√™ tem certeza que quer apagar este registro? Esta a√ß√£o n√£o pode ser desfeita.',
                {
                    confirmText: 'Apagar',
                    confirmColor: 'bg-red-600',
                    onConfirm: async () => {
                        try {
                            const dayDocRef = doc(db, "artifacts", appId, "users", userId, "diaryDays", dayId);
                            const docSnap = await getDoc(dayDocRef);
                            if (!docSnap.exists()) return;
                            
                            const dayData = docSnap.data();
                            const entryToDelete = dayData[entryType].find(e => e.id === entryId);

                            if (entryToDelete) {
                                // A l√≥gica de `arrayRemove` para deletar est√° correta.
                                await updateDoc(dayDocRef, {
                                    [entryType]: arrayRemove(entryToDelete)
                                });
                            }
                            hideModal();
                        } catch (error) {
                            console.error("Erro ao apagar:", error);
                            showModal("Erro", "Erro ao apagar registro.", { confirmText: "OK", cancelText: null });
                        }
                    }
                }
            );
        }
        
        /**
         * Calcula as estat√≠sticas de um dia
         * @param {object} day Objeto do dia
         * @returns {object} Objeto com { totalIntake, totalOutput, balance, nightlyVolume, highlights }
         */
        function calculateDayStats(day) {
            let totalIntake = 0;
            let totalOutput = 0;
            let nightlyVolume = 0;
            const highlights = [];

            day.intake.forEach(entry => {
                if (entry.type === 'liquido') {
                    totalIntake += entry.volume || 0;
                }
                // Frutas n√£o contam no volume por padr√£o, pode ser ajustado
            });

            day.output.forEach(entry => {
                const entryVolume = entry.volume || 0; // Se for n√£o quantific√°vel, volume √© 0
                totalOutput += entryVolume;
                
                // Volume noturno (22h √†s 6h)
                const entryDate = new Date(entry.datetime);
                const hour = entryDate.getHours();
                if (hour >= 22 || hour < 6) {
                    nightlyVolume += entryVolume;
                }
                
                // Destaques de residual
                if (entry.residual > 100) {
                    highlights.push({
                        level: 'danger',
                        message: `Residual alto: ${entry.residual} ml √†s ${formatDateTimeReadable(entry.datetime).split(' ')[1]}`
                    });
                } else if (entry.residual > 30) {
                    highlights.push({
                        level: 'warning',
                        message: `Residual elevado: ${entry.residual} ml √†s ${formatDateTimeReadable(entry.datetime).split(' ')[1]}`
                    });
                }
            });

            const balance = totalIntake - totalOutput;

            return { totalIntake, totalOutput, balance, nightlyVolume, highlights };
        }
        
        // --- Fluxo do Profissional ---
        
        /**
         * Lida com o login do profissional
         */
        async function handleProfLogin(event) {
            event.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorP = document.getElementById('login-error');
            const submitBtn = document.getElementById('btn-login-submit');
            
            errorP.classList.add('hidden');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Entrando...';

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // Sucesso, o onAuthStateChanged vai lidar com a mudan√ßa de tela
                submitBtn.disabled = false;
                submitBtn.textContent = 'Entrar';
            } catch (error) {
                console.error("Erro de login:", error.code);
                errorP.textContent = 'Email ou senha inv√°lidos.';
                errorP.classList.remove('hidden');
                
                // Atraso de seguran√ßa contra brute force
                setTimeout(() => {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Entrar';
                }, 2000); // 2 segundos de atraso
            }
        }

        /**
         * Lida com o logout do profissional
         */
        async function handleProfLogout() {
            try {
                // MUDAN√áA: N√£o h√° mais listeners para limpar
                await signOut(auth);
                // Limpa dados da tela
                document.getElementById('patient-data-container').classList.add('hidden');
                document.getElementById('search-prontuario').value = '';
                document.getElementById('search-status').textContent = '';
                
                showScreen('home'); // Volta para a tela inicial
            } catch (error) {
                console.error("Erro ao sair:", error);
            }
        }
        
        /**
         * Retorna os dados de TODAS as sess√µes de um prontu√°rio
         */
        async function getPatientSessionsByProntuario(prontuario) {
            const status = document.getElementById('search-status');
            status.textContent = 'Buscando...';
            status.className = 'text-sm mt-2 text-gray-600';

            const q = query(
                collection(db, "artifacts", appId, "public/data/patientIndex"),
                where("medicalRecord", "==", prontuario)
            );
            
            try {
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    status.textContent = 'Paciente n√£o encontrado.';
                    status.className = 'text-sm mt-2 text-red-600';
                    return null;
                }
                
                const sessions = [];
                querySnapshot.forEach(doc => {
                    sessions.push(doc.data());
                });

                // Ordena as sess√µes pela mais recente
                sessions.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                status.textContent = `Encontradas ${sessions.length} sess√µes para: ${sessions[0].patientName}`;
                status.className = 'text-sm mt-2 text-green-700';
                
                return sessions; // Retorna um array de sess√µes
                
            } catch (error) {
                console.error("Erro na busca:", error);
                status.textContent = 'Erro ao buscar. Verifique as regras de seguran√ßa do Firestore.';
                status.className = 'text-sm mt-2 text-red-600';
                return null;
            }
        }
        
        /**
         * Lida com a busca de m√∫ltiplas sess√µes
         */
        async function handlePatientSearch(event) {
            event.preventDefault();
            const prontuario = sanitize(document.getElementById('search-prontuario').value);
            if (!prontuario) return;

            // Limpa o container de dias
            document.getElementById('prof-days-container').innerHTML = '';

            const patientSessions = await getPatientSessionsByProntuario(prontuario);

            if (patientSessions && patientSessions.length > 0) {
                document.getElementById('patient-data-container').classList.remove('hidden');
                
                // Busca o perfil da *primeira* sess√£o (mais recente) para exibir os dados
                const firstSession = patientSessions[0];
                const profileDocRef = doc(db, "artifacts", appId, "users", firstSession.patientUserId, "patientProfile", "profile");
                const profileSnap = await getDoc(profileDocRef);

                if (profileSnap.exists()) {
                    renderProfPatientProfile(profileSnap.data());
                } else {
                    // Fallback se o perfil n√£o for encontrado
                    renderProfPatientProfile({
                        name: firstSession.patientName,
                        medicalRecord: firstSession.medicalRecord,
                        age: "N/A",
                        medications: "N/A"
                    });
                }

                // CORRE√á√ÉO: Chama a nova fun√ß√£o de carregamento e agrupamento
                loadAndMergeAllPatientData(patientSessions);

            } else {
                document.getElementById('patient-data-container').classList.add('hidden');
            }
        }
        
        /**
         * Renderiza o perfil do paciente na vis√£o do profissional
         */
        function renderProfPatientProfile(profile) {
            const container = document.getElementById('prof-patient-profile');
            container.innerHTML = `
                <div><strong>Nome:</strong> ${sanitize(profile.name)}</div>
                <div><strong>Prontu√°rio:</strong> ${sanitize(profile.medicalRecord)}</div>
                <div><strong>Idade:</strong> ${profile.age}</div>
                <div><strong>Medicamentos:</strong> ${sanitize(profile.medications) || 'N/A'}</div>
            `;
        }

        /**
         * CORRE√á√ÉO: Nova fun√ß√£o para carregar, agrupar e renderizar os dados do profissional
         * @param {Array} sessions Array de objetos de sess√£o (do patientIndex)
         */
        async function loadAndMergeAllPatientData(sessions) {
            const container = document.getElementById('prof-days-container');
            container.innerHTML = '<p class="text-center text-gray-500">Carregando e processando todos os di√°rios...</p>';

            const mergedDays = {}; // Objeto que ir√° agrupar os dias por data (ex: "2025-11-16")

            try {
                // 1. Criar um array de promessas para buscar TODOS os dias de TODAS as sess√µes
                const allDayPromises = sessions.map(session => {
                    const daysCollectionRef = collection(db, "artifacts", appId, "users", session.patientUserId, "diaryDays");
                    return getDocs(daysCollectionRef);
                });

                // 2. Esperar que todas as buscas terminem
                const allSessionSnapshots = await Promise.all(allDayPromises);

                // 3. Processar e agrupar os dados
                allSessionSnapshots.forEach((sessionSnapshot, index) => {
                    const sessionInfo = sessions[index]; // Pega a info da sess√£o (data, userId)

                    sessionSnapshot.forEach(dayDoc => {
                        const dayData = dayDoc.data();
                        const date = dayData.date; // A data YYYY-MM-DD

                        // Se √© a primeira vez que vemos este dia, cria a estrutura
                        if (!mergedDays[date]) {
                            mergedDays[date] = {
                                id: date, // Usa a data como ID
                                date: date,
                                intake: [],
                                output: [],
                                sessions: [] // Guarda de quais sess√µes este dia veio
                            };
                        }

                        // Agrupa (combina) os arrays de intake e output
                        mergedDays[date].intake.push(...dayData.intake);
                        mergedDays[date].output.push(...dayData.output);
                        mergedDays[date].sessions.push(sessionInfo);
                    });
                });

                // 4. Renderizar os dados agrupados
                container.innerHTML = ''; // Limpa o "carregando"

                const sortedDates = Object.keys(mergedDays).sort().reverse(); // Ordena (mais recente primeiro)

                if (sortedDates.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500 bg-white p-6 rounded-xl shadow-md">Este paciente n√£o possui registros em nenhuma sess√£o.</p>';
                    return;
                }

                sortedDates.forEach(date => {
                    const dayData = mergedDays[date];
                    // 'dayData' agora cont√©m os arrays combinados e a lista de sess√µes
                    const dayCard = createDayCard(dayData, 'prof');
                    container.appendChild(dayCard);
                });

            } catch (error) {
                console.error("Erro ao carregar e agrupar dados do paciente:", error);
                container.innerHTML = `<p class="text-red-600">Erro ao processar o di√°rio: ${error.message}</p>`;
            }
        }
        

        // --- Event Listeners Iniciais ---
        
        window.onload = initializeFirebase;

        // Navega√ß√£o Home
        document.getElementById('btn-go-patient').onclick = signInPatient;
        document.getElementById('btn-go-prof').onclick = () => showScreen('profLogin');
        document.getElementById('btn-back-to-home').onclick = () => showScreen('home');
        // Listener para o novo bot√£o "Voltar"
        document.getElementById('btn-reg-back-to-home').onclick = () => showScreen('home');

        // Forms
        document.getElementById('patient-register-form').onsubmit = handlePatientRegister;
        document.getElementById('prof-login-form').onsubmit = handleProfLogin;
        document.getElementById('patient-search-form').onsubmit = handlePatientSearch;
        
        // Bot√µes do Di√°rio
        document.getElementById('btn-add-day').onclick = handleAddDay;
        
        // ADICIONADO: Listener para o bot√£o de logout do paciente
        document.getElementById('btn-patient-logout').onclick = async () => {
            if (auth) {
                await signOut(auth); // Faz logout do usu√°rio an√¥nimo/paciente
            }
            showScreen('home'); // Volta para a tela inicial
        };

    </script>
    
    <!-- 
    ===========================================================================================
    INSTRU√á√ïES DE CONFIGURA√á√ÉO DO FIREBASE (Simplificado)
    ===========================================================================================
    
    COMO CORRIGIR O LOGIN DE PROFISSIONAL (LEIA COM ATEN√á√ÉO):
    
    O erro que voc√™ viu (ir para a tela de paciente) acontece because sua conta
    ainda n√£o tem "permiss√£o de profissional". O login e senha est√£o corretos,
    mas o app n√£o o reconhece como admin.
    
    Siga estes 3 passos para corrigir:

    1. CRIE O USU√ÅRIO PROFISSIONAL (NO FIREBASE AUTHENTICATION)
       a. V√° ao seu Console do Firebase -> Authentication -> Users -> "Add user".
       b. Crie o email e senha do profissional.
       c. Copie o "User UID" (ex: "abc123xyz") do usu√°rio que voc√™ acabou de criar.
    
    2. ADICIONE O PROFISSIONAL √Ä "LISTA DE ADMINS" (NO FIRESTORE DATABASE)
       a. V√° ao seu Console do Firebase -> Firestore Database.
       b. Clique em "+ Start collection" (Iniciar cole√ß√£o).
       c. Digite o ID da cole√ß√£o: `administradores` (tudo min√∫sculo e no plural).
       d. Clique em "Next".
       e. Em "Document ID", COLE o "User UID" que voc√™ copiou (ex: "abc123xyz").
       f. Adicione um campo (opcional):
          - Field: `email`
          - Value: `email.do.profissional@exemplo.com`
       g. Clique em "Save".
    
    3. ATUALIZE AS REGRAS DE SEGURAN√áA (NO FIRESTORE DATABASE)
       a. V√° ao seu Console do Firebase -> Firestore Database -> "Rules" (Regras).
       b. Apague tudo e cole as regras abaixo. (Elas s√£o essenciais para
          permitir que o app verifique a lista de administradores).
    
    ================ IN√çCIO DAS REGRAS DO FIRESTORE (VERS√ÉO CORRIGIDA) ================
    rules_version = '2';
    
    service cloud.firestore {
      match /databases/{database}/documents {
      
        // Fun√ß√£o helper (usada pelas regras abaixo)
        // Verifica se o UID do utilizador existe na cole√ß√£o de administradores
        function isProfessional() {
          return request.auth != null && 
                 exists(/databases/$(database)/documents/administradores/$(request.auth.uid));
        }
        
        // Acesso √† lista de administradores
        match /administradores/{userId} {
            // CORRE√á√ÉO: Permite que *qualquer utilizador autenticado*
            // verifique a exist√™ncia (get) de um documento de administrador.
            allow get: if request.auth != null; 
            
            // Ningu√©m pode listar, escrever ou apagar (isto √© feito manually)
            allow list, write, delete: if false; 
        }

        // Caminho do App (use 'diario-miccional-1' ou $(appId))
        match /artifacts/{appId} {
        
          // --- REGRAS DO PACIENTE (DADOS PRIVADOS) ---
          // O paciente s√≥ pode ler e escrever OS SEUS PR√ìPRIOS dados
          match /users/{userId}/{collection}/{docId} {
            allow read, write: if request.auth.uid == userId;
          }
          
          // --- REGRAS DO PROFISSIONAL (LER DADOS DO PACIENTE) ---
          match /users/{patientId}/patientProfile/profile {
             // S√≥ permite "get" (ler) se o utilizador for profissional
             allow get: if isProfessional();
          }
          match /users/{patientId}/diaryDays/{dayId} {
             // S√≥ permite "get" (ler) e "list" (listar dias) se for profissional
             allow get, list: if isProfessional();
          }
          
          // --- REGRAS DO √çNDICE P√öBLICO (PARA BUSCA) ---
          match /public/data/patientIndex/{docId} {
            // O paciente s√≥ pode criar O SEU PR√ìPRIO √≠ndice
            allow create: if request.auth.uid == request.resource.data.patientUserId;
            
            // O profissional pode LER (listar/buscar) o √≠ndice
            allow list, get: if isProfessional();
            
            // Ningu√©m pode atualizar ou apagar
            allow update, delete: if false;
          }
        }
      }
    }
    ================ FIM DAS REGRAS DO FIRESTORE ================

    -->
</body>
</html>
