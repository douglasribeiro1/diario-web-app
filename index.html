<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diário Miccional</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Biblioteca jsPDF para exportar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <!-- Lottie (Animação) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>

    <style>
        /* Estilos personalizados */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Para navegadores Webkit (Chrome, Safari) */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #c0c0c0;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a0a0a0;
        }
        
        /* Classe para destacar campos com erro */
        .input-error {
            border-color: #ef4444; /* Vermelho do Tailwind (red-500) */
            box-shadow: 0 0 0 2px #fecaca; /* Sombra vermelha leve (red-200) */
        }

        /* Animação de entrada suave */
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Destaques de volume residual */
        .highlight-yellow {
            background-color: #fef9c3; /* Amarelo 100 */
            color: #713f12; /* Amarelo 900 */
            font-weight: bold;
        }
        .highlight-red {
            background-color: #fee2e2; /* Vermelho 100 */
            color: #991b1b; /* Vermelho 900 */
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 antialiased">

    <!-- Estrutura Principal da App -->
    <div id="app-container" class="max-w-xl mx-auto min-h-screen bg-white shadow-lg">

        <!-- 1. Tela de Carregamento Inicial -->
        <div id="screen-loading" class="flex flex-col items-center justify-center min-h-screen p-8 text-center">
            <div id="lottie-loading" class="w-48 h-48"></div>
            <h1 class="text-2xl font-bold text-blue-600">Carregando diário...</h1>
            <p class="text-gray-500 mt-2">Aguarde um momento.</p>
        </div>

        <!-- 2. Tela Inicial (Escolha de Perfil) -->
        <div id="screen-home" class="hidden flex flex-col items-center justify-center min-h-screen p-8 fade-in">
            <h1 class="text-3xl font-bold text-center text-blue-800 mb-6">Diário Miccional Digital</h1>
            <p class="text-xl text-center text-gray-600 mb-12">Você é Paciente ou Profissional de Saúde?</p>
            
            <button id="btn-go-patient" class="w-full bg-blue-600 text-white text-2xl font-bold py-6 px-8 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-300 ease-in-out mb-6">
                Paciente
            </button>
            
            <button id="btn-go-professional" class="w-full bg-gray-700 text-white text-2xl font-bold py-6 px-8 rounded-lg shadow-md hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50 transition duration-300 ease-in-out">
                Profissional
            </button>
        </div>

        <!-- 3. Área do Paciente -->
        <div id="screen-patient-area" class="hidden flex flex-col min-h-screen p-6 fade-in">
            
            <!-- 3a. Cadastro do Paciente (Se não houver dados) -->
            <div id="patient-registration-form" class="hidden">
                <header class="mb-6">
                    <h2 class="text-3xl font-bold text-blue-800">Seu Cadastro</h2>
                    <p class="text-gray-600">Precisamos de alguns dados para começar.</p>
                </header>
                
                <form id="form-patient-register" class="space-y-4">
                    <div>
                        <label for="reg-prontuario" class="block text-sm font-medium text-gray-700">Número de Prontuário *</label>
                        <input type="text" id="reg-prontuario" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                    </div>
                    <div>
                        <label for="reg-nome" class="block text-sm font-medium text-gray-700">Nome Completo *</label>
                        <input type="text" id="reg-nome" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                    </div>
                    <div>
                        <label for="reg-idade" class="block text-sm font-medium text-gray-700">Idade *</label>
                        <input type="number" id="reg-idade" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                    </div>
                    <div>
                        <label for="reg-medicamentos" class="block text-sm font-medium text-gray-700">Medicamentos em uso</label>
                        <textarea id="reg-medicamentos" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ex: Losartana 50mg, AAS 100mg..."></textarea>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                        Salvar e Iniciar Diário
                    </button>
                </form>
            </div>

            <!-- 3b. Diário Miccional (Se houver dados) -->
            <div id="patient-diary-view" class="hidden">
                <header class="flex justify-between items-center mb-6 pb-4 border-b">
                    <div>
                        <h2 class="text-3xl font-bold text-blue-800">Meu Diário</h2>
                        <p id="patient-name-display" class="text-gray-600 font-medium"></p>
                    </div>
                    <button id="btn-add-new-day" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400">
                        + Adicionar Dia
                    </button>
                </header>

                <!-- Lista de Dias -->
                <div id="diary-days-list" class="space-y-6">
                    <!-- O conteúdo de cada dia será inserido aqui dinamicamente -->
                    <!-- Exemplo de um dia:
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Dia: 15/11/2025</h3>
                        
                        <div class="mb-4">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="text-lg font-semibold text-blue-700">Entradas (Líquidos/Frutas)</h4>
                                <button class="btn-add-entry text-blue-600 hover:text-blue-800 font-medium">+ Adicionar</button>
                            </div>
                            <ul class="list-disc list-inside text-gray-700 space-y-1">
                                <li>10:00 - Água - 200ml <button class="text-red-500 text-xs ml-2">Apagar</button></li>
                                <li>12:30 - Melancia <button class="text-red-500 text-xs ml-2">Apagar</button></li>
                            </ul>
                        </div>

                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="text-lg font-semibold text-red-700">Saídas (Micção)</h4>
                                <button class="btn-add-exit text-red-600 hover:text-red-800 font-medium">+ Adicionar</button>
                            </div>
                            <ul class="list-disc list-inside text-gray-700 space-y-1">
                                <li>11:00 - 300ml - Banheiro - Residual 0ml <button class="text-red-500 text-xs ml-2">Apagar</button></li>
                                <li>14:00 - ++ (Moderada) - Fralda - Residual 50ml <button class="text-red-500 text-xs ml-2 highlight-yellow">Apagar</button></li>
                            </ul>
                        </div>
                    </div>
                    -->
                </div>
            </div>
        </div>

        <!-- 4. Área do Profissional -->
        <div id="screen-professional-area" class="hidden flex flex-col min-h-screen fade-in">
            
            <!-- 4a. Login do Profissional -->
            <div id="professional-login-form" class="flex flex-col justify-center min-h-screen p-8">
                <header class="mb-8 text-center">
                    <h2 class="text-3xl font-bold text-blue-800">Área do Profissional</h2>
                    <p class="text-gray-600">Acesso restrito.</p>
                </header>
                
                <form id="form-prof-login" class="space-y-4">
                    <div>
                        <label for="prof-email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="prof-email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                    </div>
                    <div>
                        <label for="prof-password" class="block text-sm font-medium text-gray-700">Senha</label>
                        <input type="password" id="prof-password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                    </div>
                    <button type="submit" id="btn-prof-login-submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                        Entrar
                    </button>
                    <button type="button" id="btn-prof-back-home" class="w-full text-center text-gray-600 font-medium py-2 rounded-lg hover:bg-gray-100">
                        Voltar
                    </button>
                    <p id="prof-login-error" class="text-red-600 text-sm text-center hidden"></p>
                </form>
            </div>

            <!-- 4b. Painel do Profissional (Após Login) -->
            <div id="professional-dashboard" class="hidden p-6">
                <header class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 pb-4 border-b">
                    <div>
                        <h2 class="text-3xl font-bold text-blue-800">Painel do Profissional</h2>
                        <p id="prof-email-display" class="text-gray-600"></p>
                    </div>
                    <button id="btn-prof-logout" class="mt-2 sm:mt-0 w-full sm:w-auto bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-400">
                        Sair
                    </button>
                </header>

                <!-- Barra de Busca -->
                <div class="mb-6">
                    <label for="search-prontuario" class="block text-sm font-medium text-gray-700">Buscar Prontuário</label>
                    <div class="flex mt-1">
                        <input type="text" id="search-prontuario" class="flex-grow px-3 py-2 border border-gray-300 rounded-l-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Digite o nº do prontuário...">
                        <button id="btn-search-prontuario" class="bg-blue-600 text-white font-bold px-4 rounded-r-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            Buscar
                        </button>
                    </div>
                    <p id="search-error" class="text-red-600 text-sm mt-1 hidden"></p>
                </div>

                <!-- Área de Resultados do Paciente -->
                <div id="patient-data-view" class="hidden space-y-6">
                    
                    <!-- Dados Cadastrais -->
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200">
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Dados Cadastrais</h3>
                        <p><strong>Nome:</strong> <span id="view-patient-name"></span></p>
                        <p><strong>Idade:</strong> <span id="view-patient-idade"></span></p>
                        <p><strong>Prontuário:</strong> <span id="view-patient-prontuario"></span></p>
                        <p><strong>Medicamentos:</strong> <span id="view-patient-medicamentos" class="whitespace-pre-wrap"></span></p>
                    </div>

                    <!-- Botões de Exportação -->
                    <div class="flex gap-4">
                        <button id="btn-export-all-prof" class="flex-1 bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400">
                            Exportar Tudo (PDF)
                        </button>
                    </div>

                    <!-- Lista de Dias (Visão Profissional) -->
                    <div id="prof-diary-days-list" class="space-y-6">
                        <!-- Conteúdo do diário do paciente (somente leitura) -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Genérico (Usado para Adicionar/Confirmar/Alertar) -->
    <div id="modal-container" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div id="modal-content" class="bg-white w-full max-w-lg rounded-lg shadow-xl p-6 relative fade-in">
            <!-- Conteúdo do Modal será injetado aqui -->
        </div>
    </div>


    <!-- Firebase e Lógica da App -->
    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            signInAnonymously, 
            onAuthStateChanged, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            collection, 
            onSnapshot, 
            query, 
            where, 
            getDocs,
            deleteDoc,
            writeBatch,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variáveis globais
        let db, auth;
        let currentUserId = null;
        let currentDayId = null; // Usado para saber qual dia adicionar registro
        let currentPatientData = null; // Dados do paciente (visão prof)
        let currentPatientDiary = null; // Dados do diário (visão prof)

        // Funções de unsubscrive (para parar de ouvir dados)
        let currentPatientDataUnsubscribe = null; // Função para parar listener do paciente (visão do prof)
        let currentPatientDiaryUnsubscribe = null; // Listener do diário (visão do paciente)

        // =======================================================================
        // !! ETAPA DE CONFIGURAÇÃO OBRIGATÓRIA !!
        // Cole suas chaves do Firebase que você copiou na Etapa 2 do GUIA.
        // O app NÃO vai funcionar sem isso.
        //
        // SE VOCÊ VER O ERRO "Unexpected token '}'" (Token '}' inesperado):
        // Isso é 100% um erro de copiar e colar.
        // Apague o bloco 'const firebaseConfig' abaixo (linhas 350-357)
        // e cole o bloco NOVO e COMPLETO do Firebase no lugar.
        // =======================================================================
        
        // 1. Cole seu objeto 'firebaseConfig' aqui (substitua este bloco todo):
const firebaseConfig = {
  apiKey: "AIzaSyCZRKyT20a_jdD9oZWCq9iy9nTxER5pGWg",
  authDomain: "diario-miccional-1.firebaseapp.com",
  projectId: "diario-miccional-1",
  storageBucket: "diario-miccional-1.firebasestorage.app",
  messagingSenderId: "427993247976",
  appId: "1:427993247976:web:ef1c82c8a1d7db3ed3595d"
};
        
        // 2. Defina um ID único para seu app (deve ser o MESMO das Regras do Firestore):
        const appId = 'diario-miccional-default';
        
        // =======================================================================

        // --- Seletores de DOM ---
        const screens = {
            loading: document.getElementById('screen-loading'),
            home: document.getElementById('screen-home'),
            patient: document.getElementById('screen-patient-area'),
            professional: document.getElementById('screen-professional-area'),
        };
        
        const patientViews = {
            registration: document.getElementById('patient-registration-form'),
            diary: document.getElementById('patient-diary-view'),
        };

        const profViews = {
            login: document.getElementById('professional-login-form'),
            dashboard: document.getElementById('professional-dashboard'),
        };

        const modal = {
            container: document.getElementById('modal-container'),
            content: document.getElementById('modal-content'),
        };

        const lottieLoading = document.getElementById('lottie-loading');

        // --- Funções de Navegação e UI ---

        /** Mostra uma tela e esconde as outras */
        function showScreen(screenName) {
            Object.values(screens).forEach(screen => screen.classList.add('hidden'));
            if (screens[screenName]) {
                screens[screenName].classList.remove('hidden');
            }
        }

        /** Mostra uma sub-tela da área do paciente */
        function showPatientView(viewName) {
            Object.values(patientViews).forEach(view => view.classList.add('hidden'));
            if (patientViews[viewName]) {
                patientViews[viewName].classList.remove('hidden');
            }
            showScreen('patient');
        }

        /** Mostra uma sub-tela da área do profissional */
        function showProfView(viewName) {
            Object.values(profViews).forEach(view => view.classList.add('hidden'));
            if (profViews[viewName]) {
                profViews[viewName].classList.remove('hidden');
            }
            showScreen('professional');
        }

        /** Mostra o Modal com conteúdo HTML */
        function showModal(htmlContent) {
            modal.content.innerHTML = htmlContent;
            modal.container.classList.remove('hidden');
        }

        /** Esconde o Modal */
        function hideModal() {
            modal.container.classList.add('hidden');
            modal.content.innerHTML = '';
        }

        /** Sanitiza input (remove tags HTML e caracteres perigosos) */
        function sanitizeInput(str) {
            if (!str) return '';
            // Remove tags HTML
            let sanitized = str.replace(/<[^>]*>?/gm, '');
            // Remove caracteres que podem ser usados em ataques (simplificado)
            sanitized = sanitized.replace(/[<>$%{}()]/g, '');
            return sanitized.trim();
        }

        /** Valida um campo e adiciona/remove classe de erro */
        function validateField(inputElement) {
            const sanitizedValue = sanitizeInput(inputElement.value);
            inputElement.value = sanitizedValue; // Atualiza o valor no campo
            
            if (!sanitizedValue) {
                inputElement.classList.add('input-error');
                return false;
            } else {
                inputElement.classList.remove('input-error');
                return true;
            }
        }
        
        /** Formata data (DD/MM/YYYY) */
        function formatDate(date) {
            return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        /** Formata hora (HH:MM) */
        function formatTime(date) {
            return date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }
        
        /** Converte string 'YYYY-MM-DD' e 'HH:MM' para Date */
        function parseDateTime(dateStr, timeStr) {
            return new Date(`${dateStr}T${timeStr}:00`);
        }
        
        /** Pega a data e hora atual formatada para inputs */
        function getCurrentDateTime() {
            const now = new Date();
            const date = now.toISOString().split('T')[0];
            const time = formatTime(now);
            return { date, time };
        }

        // --- Funções de Lógica do Diário (Cálculos) ---

        /** Calcula o balanço diário e o volume noturno */
        function calculateDailySummary(day) {
            let totalEntries = 0;
            let totalExits = 0;
            let nightVolume = 0;

            const entries = day.entries || [];
            const exits = day.exits || [];

            entries.forEach(entry => {
                if (entry.type === 'liquido' && entry.volume) {
                    totalEntries += Number(entry.volume);
                }
            });

            exits.forEach(exit => {
                const exitTime = exit.timestamp.toDate().getHours();
                
                if (exit.type === 'quantificavel' && exit.volume) {
                    const volume = Number(exit.volume);
                    totalExits += volume;

                    // Volume noturno (22h às 06h)
                    if (exitTime >= 22 || exitTime < 6) {
                        nightVolume += volume;
                    }
                }
            });

            const balance = totalEntries - totalExits;
            return { totalEntries, totalExits, balance, nightVolume };
        }

        /** Retorna classe de destaque para volume residual */
        function getHighlightClass(residual) {
            const resVal = Number(residual);
            if (resVal > 100) return 'highlight-red';
            if (resVal > 30) return 'highlight-yellow';
            return '';
        }

        /** Formata o volume de saída (para '++' etc) */
        function formatExitVolume(exit) {
            if (exit.type === 'quantificavel') {
                return `${exit.volume}ml`;
            }
            return exit.intensity || 'N/Q'; // N/Q = Não Quantificável
        }

        // --- Funções de Geração de HTML ---

        /** Gera o HTML para um único dia do diário (visão paciente e prof) */
        function createDayCardHTML(day, isProfessionalView = false) {
            const { totalEntries, totalExits, balance, nightVolume } = calculateDailySummary(day);
            const dayDate = day.dayDate.toDate();
            const dayId = day.id;

            // ---- HTML das Entradas ----
            const entriesHTML = (day.entries || [])
                .sort((a, b) => a.timestamp.toDate() - b.timestamp.toDate())
                .map(entry => {
                    const time = formatTime(entry.timestamp.toDate());
                    const details = entry.type === 'liquido' 
                        ? `Líquido (${entry.volume}ml)` 
                        : `Fruta (${entry.fruitName})`;
                    const deleteButton = isProfessionalView ? '' : 
                        `<button class="btn-delete-entry text-red-500 text-xs ml-2 hover:text-red-700" data-day-id="${dayId}" data-entry-id="${entry.id}">(Apagar)</button>`;
                    
                    return `<li class="text-sm">${time} - ${details} ${deleteButton}</li>`;
                }).join('');

            // ---- HTML das Saídas ----
            const exitsHTML = (day.exits || [])
                .sort((a, b) => a.timestamp.toDate() - b.timestamp.toDate())
                .map(exit => {
                    const time = formatTime(exit.timestamp.toDate());
                    const volume = formatExitVolume(exit);
                    const location = exit.location || 'N/A';
                    const residual = exit.residualVolume || 0;
                    const highlight = getHighlightClass(residual);
                    const deleteButton = isProfessionalView ? '' :
                        `<button class="btn-delete-exit text-red-500 text-xs ml-2 hover:text-red-700" data-day-id="${dayId}" data-exit-id="${exit.id}">(Apagar)</button>`;

                    return `<li class="text-sm ${highlight} p-1 rounded">
                        ${time} - ${volume} (Local: ${location}) - Residual: ${residual}ml ${deleteButton}
                    </li>`;
                }).join('');
            
            // ---- Botões (Visão do Paciente) ----
            const patientButtons = isProfessionalView ? '' : `
                <div class="grid grid-cols-2 gap-2 mt-4">
                    <button class="btn-add-entry w-full text-sm bg-blue-500 text-white py-2 px-3 rounded-lg hover:bg-blue-600" data-day-id="${dayId}">+ Entrada</button>
                    <button class="btn-add-exit w-full text-sm bg-red-500 text-white py-2 px-3 rounded-lg hover:bg-red-600" data-day-id="${dayId}">+ Saída</button>
                </div>
            `;
            
            // ---- Botões (Visão do Profissional) ----
            const profButtons = isProfessionalView ? `
                <div class="mt-4">
                    <button class="btn-export-day-prof w-full text-sm bg-green-500 text-white py-2 px-3 rounded-lg hover:bg-green-600" data-day-id="${dayId}" data-date-str="${formatDate(dayDate)}">
                        Exportar este dia (PDF)
                    </button>
                </div>
            ` : '';

            // ---- Card Completo ----
            return `
                <div class="day-card bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200" data-day-id="${dayId}">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Dia: ${formatDate(dayDate)}</h3>
                    
                    <!-- Balanço -->
                    <div class="bg-white p-3 rounded-md border mb-4 space-y-2">
                        <h4 class="text-md font-semibold text-gray-700 mb-2">Balanço do Dia</h4>
                        <p class="text-sm"><strong>Total Entradas:</strong> ${totalEntries} ml</p>
                        <p class="text-sm"><strong>Total Saídas:</strong> ${totalExits} ml</p>
                        <p class="text-lg font-bold ${balance >= 0 ? 'text-green-700' : 'text-red-700'}">
                            Balanço: ${balance} ml
                        </p>
                        <p class="text-sm"><strong>Volume Urinário Noturno (22h-06h):</strong> ${nightVolume} ml</p>
                    </div>

                    <!-- Entradas -->
                    <div class="mb-4">
                        <h4 class="text-lg font-semibold text-blue-700 mb-2">Entradas (Líquidos/Frutas)</h4>
                        <ul class="list-disc list-inside text-gray-700 space-y-1 ml-1">
                            ${entriesHTML || '<li class="text-sm text-gray-500">Nenhum registro de entrada.</li>'}
                        </ul>
                    </div>

                    <!-- Saídas -->
                    <div class="mb-4">
                        <h4 class="text-lg font-semibold text-red-700 mb-2">Saídas (Micção)</h4>
                        <ul class="list-disc list-inside text-gray-700 space-y-1 ml-1">
                            ${exitsHTML || '<li class="text-sm text-gray-500">Nenhum registro de saída.</li>'}
                        </ul>
                    </div>

                    ${patientButtons}
                    ${profButtons}
                </div>
            `;
        }

        // --- Funções de Modal ---

        /** Modal para Adicionar Entrada (Líquido/Fruta) */
        function showAddEntryModal() {
            const { date, time } = getCurrentDateTime();
            const html = `
                <h3 class="text-2xl font-bold text-blue-800 mb-4">Adicionar Entrada</h3>
                <form id="form-add-entry" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="entry-date" class="block text-sm font-medium text-gray-700">Data</label>
                            <input type="date" id="entry-date" value="${date}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                        </div>
                        <div>
                            <label for="entry-time" class="block text-sm font-medium text-gray-700">Hora</label>
                            <input type="time" id="entry-time" value="${time}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Tipo</label>
                        <div class="flex gap-4 mt-1">
                            <label class="flex items-center">
                                <input type="radio" name="entry-type" value="liquido" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300" checked>
                                <span class="ml-2 text-sm text-gray-700">Líquido</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="entry-type" value="fruta" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300">
                                <span class="ml-2 text-sm text-gray-700">Fruta</span>
                            </label>
                        </div>
                    </div>
                    
                    <div id="entry-liquido-fields">
                        <label for="entry-volume" class="block text-sm font-medium text-gray-700">Volume (ml)</label>
                        <input type="number" id="entry-volume" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ex: 200">
                    </div>
                    
                    <div id="entry-fruta-fields" class="hidden">
                        <label for="entry-fruta" class="block text-sm font-medium text-gray-700">Nome da Fruta</label>
                        <input type="text" id="entry-fruta" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ex: Melancia">
                    </div>
                    
                    <div class="flex gap-4 pt-4">
                        <button type="button" id="btn-modal-cancel" class="w-full bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button>
                        <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Salvar</button>
                    </div>
                </form>
            `;
            showModal(html);

            // Lógica interna do modal (troca de campos)
            document.querySelectorAll('input[name="entry-type"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    if (e.target.value === 'liquido') {
                        document.getElementById('entry-liquido-fields').classList.remove('hidden');
                        document.getElementById('entry-fruta-fields').classList.add('hidden');
                    } else {
                        document.getElementById('entry-liquido-fields').classList.add('hidden');
                        document.getElementById('entry-fruta-fields').classList.remove('hidden');
                    }
                });
            });
        }

        /** Modal para Adicionar Saída (Micção) */
        function showAddExitModal() {
            const { date, time } = getCurrentDateTime();
            const html = `
                <h3 class="text-2xl font-bold text-red-800 mb-4">Adicionar Saída (Micção)</h3>
                <form id="form-add-exit" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="exit-date" class="block text-sm font-medium text-gray-700">Data</label>
                            <input type="date" id="exit-date" value="${date}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                        </div>
                        <div>
                            <label for="exit-time" class="block text-sm font-medium text-gray-700">Hora</label>
                            <input type="time" id="exit-time" value="${time}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" required>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Volume Urinado</label>
                        <div class="flex gap-4 mt-1">
                            <label class="flex items-center">
                                <input type="radio" name="exit-type" value="quantificavel" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300" checked>
                                <span class="ml-2 text-sm text-gray-700">Quantificável</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="exit-type" value="nao-quantificavel" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300">
                                <span class="ml-2 text-sm text-gray-700">Não Quantificável</span>
                            </label>
                        </div>
                    </div>
                    
                    <div id="exit-quantificavel-fields">
                        <label for="exit-volume" class="block text-sm font-medium text-gray-700">Volume (ml)</label>
                        <input type="number" id="exit-volume" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Ex: 300">
                    </div>
                    
                    <div id="exit-nao-quantificavel-fields" class="hidden">
                        <label for="exit-intensity" class="block text-sm font-medium text-gray-700">Intensidade</label>
                        <select id="exit-intensity" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="+ (leve)">+ (leve)</option>
                            <option value="++ (moderada)">++ (moderada)</option>
                            <option value="+++ (intensa)">+++ (intensa)</option>
                        </select>
                    </div>

                    <div>
                        <label for="exit-location" class="block text-sm font-medium text-gray-700">Local</label>
                        <select id="exit-location" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option>Banheiro</option>
                            <option>Fralda</option>
                            <option>Coletor</option>
                            <option>Outro</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="exit-residual" class="block text-sm font-medium text-gray-700">Volume Residual (Bladder) em ml</label>
                        <input type="number" id="exit-residual" value="0" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>

                    <div class="flex gap-4 pt-4">
                        <button type="button" id="btn-modal-cancel" class="w-full bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button>
                        <button type="submit" class="w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700">Salvar</button>
                    </div>
                </form>
            `;
            showModal(html);

            // Lógica interna do modal (troca de campos)
            document.querySelectorAll('input[name="exit-type"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    if (e.target.value === 'quantificavel') {
                        document.getElementById('exit-quantificavel-fields').classList.remove('hidden');
                        document.getElementById('exit-nao-quantificavel-fields').classList.add('hidden');
                    } else {
                        document.getElementById('exit-quantificavel-fields').classList.add('hidden');
                        document.getElementById('exit-nao-quantificavel-fields').classList.remove('hidden');
                    }
                });
            });
        }

        /** Modal de Confirmação (genérico) */
        function showConfirmationModal(title, message, confirmText, onConfirm) {
            const html = `
                <h3 class="text-2xl font-bold text-gray-900 mb-4">${title}</h3>
                <p class="text-gray-600 mb-6">${message}</p>
                <div class="flex gap-4">
                    <button type="button" id="btn-modal-cancel" class="w-full bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button type="button" id="btn-modal-confirm" class="w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700">${confirmText}</button>
                </div>
            `;
            showModal(html);

            document.getElementById('btn-modal-confirm').addEventListener('click', () => {
                onConfirm(); // Executa a ação de confirmação
                hideModal();
            });
            // O botão de cancelar é tratado pelo listener global
        }

        // --- Funções do Firebase (Paciente) ---

        /** Caminho para o perfil do paciente */
        function getPatientProfileRef(userId) {
            return doc(db, `artifacts/${appId}/users/${userId}/patientProfile/profile`);
        }

        /** Caminho para a coleção de dias do diário */
        function getPatientDiaryCollectionRef(userId) {
            return collection(db, `artifacts/${appId}/users/${userId}/diaryDays`);
        }
        
        /** Caminho para um dia específico do diário */
        function getPatientDiaryDayRef(userId, dayId) {
            return doc(db, `artifacts/${appId}/users/${userId}/diaryDays/${dayId}`);
        }
        
        /** Caminho para o índice público de pacientes */
        function getPublicIndexRef() {
            return collection(db, `artifacts/${appId}/public/data/patientIndex`);
        }

        /** Salva o cadastro inicial do paciente */
        async function registerPatient(prontuario, nome, idade, medicamentos) {
            if (!currentUserId) return;
            
            const profileRef = getPatientProfileRef(currentUserId);
            const indexRef = getPublicIndexRef();
            
            const profileData = {
                prontuario,
                nome,
                idade: Number(idade),
                medicamentos,
                userId: currentUserId,
                createdAt: serverTimestamp()
            };
            
            const indexData = {
                prontuario,
                nome: nome.toLowerCase(), // Para busca
                patientUserId: currentUserId // Link para os dados privados
            };

            try {
                // Usar um batch para garantir que ambos sejam escritos
                const batch = writeBatch(db);
                
                // 1. Salva o perfil privado
                batch.set(profileRef, profileData);
                
                // 2. Salva o índice público (para busca do profissional)
                // O ID do documento de índice será o mesmo prontuário
                const indexDocRef = doc(indexRef, prontuario);
                batch.set(indexDocRef, indexData);
                
                await batch.commit();
                
                console.log('Paciente e índice cadastrados!');
                checkPatientData(currentUserId); // Recarrega os dados
            } catch (error) {
                console.error("Erro ao cadastrar paciente: ", error);
                alert("Erro ao salvar cadastro. Tente novamente.");
            }
        }

        /** Ouve os dados do diário do paciente (real-time) */
        function listenToPatientDiary(userId) {
            // Se já estiver ouvindo, pare
            if (currentPatientDiaryUnsubscribe) {
                currentPatientDiaryUnsubscribe();
            }
            
            const diaryRef = getPatientDiaryCollectionRef(userId);
            const q = query(diaryRef); // TODO: Adicionar orderBy e limit se necessário

            currentPatientDiaryUnsubscribe = onSnapshot(q, (snapshot) => {
                const days = [];
                snapshot.forEach(doc => {
                    days.push({ id: doc.id, ...doc.data() });
                });
                
                // Ordena os dias pela data (mais recente primeiro)
                days.sort((a, b) => b.dayDate.toDate() - a.dayDate.toDate());
                
                // Renderiza os dias
                const listEl = document.getElementById('diary-days-list');
                if (days.length === 0) {
                    listEl.innerHTML = `<p class="text-gray-500 text-center">Nenhum dia registrado. Clique em "Adicionar Dia" para começar.</p>`;
                } else {
                    listEl.innerHTML = days.map(day => createDayCardHTML(day, false)).join('');
                }
            }, (error) => {
                console.error("Erro ao ouvir diário: ", error);
            });
        }

        /** Adiciona um novo dia ao diário */
        async function addNewDay() {
            if (!currentUserId) return;
            
            const diaryRef = getPatientDiaryCollectionRef(currentUserId);
            const newDay = {
                dayDate: serverTimestamp(), // Usa a data atual do servidor
                entries: [],
                exits: []
            };

            try {
                await addDoc(diaryRef, newDay);
                console.log("Novo dia adicionado!");
            } catch (error) {
                console.error("Erro ao adicionar novo dia: ", error);
                alert("Erro ao adicionar dia. Tente novamente.");
            }
        }

        /** Adiciona um registro de ENTRADA a um dia */
        async function addEntryToDay(dayId, entryData) {
            if (!currentUserId || !dayId) return;

            const dayRef = getPatientDiaryDayRef(currentUserId, dayId);
            
            try {
                // Para adicionar a um array, precisamos ler, modificar e salvar
                const dayDoc = await getDoc(dayRef);
                if (!dayDoc.exists()) {
                    throw new Error("Dia não encontrado");
                }
                
                const dayData = dayDoc.data();
                const newEntries = dayData.entries || [];
                
                // Adiciona um ID único simples (baseado no timestamp)
                entryData.id = `entry_${new Date().getTime()}`;
                
                newEntries.push(entryData);
                
                await setDoc(dayRef, { entries: newEntries }, { merge: true });
                console.log("Entrada adicionada!");
                hideModal();
            } catch (error) {
                console.error("Erro ao adicionar entrada: ", error);
                alert("Erro ao salvar entrada. Tente novamente.");
            }
        }

        /** Adiciona um registro de SAÍDA a um dia */
        async function addExitToDay(dayId, exitData) {
            if (!currentUserId || !dayId) return;

            const dayRef = getPatientDiaryDayRef(currentUserId, dayId);
            
            try {
                const dayDoc = await getDoc(dayRef);
                if (!dayDoc.exists()) {
                    throw new Error("Dia não encontrado");
                }
                
                const dayData = dayDoc.data();
                const newExits = dayData.exits || [];
                
                exitData.id = `exit_${new Date().getTime()}`;
                newExits.push(exitData);
                
                await setDoc(dayRef, { exits: newExits }, { merge: true });
                console.log("Saída adicionada!");
                hideModal();
            } catch (error) {
                console.error("Erro ao adicionar saída: ", error);
                alert("Erro ao salvar saída. Tente novamente.");
            }
        }

        /** Apaga um registro de ENTRADA */
        async function deleteEntry(dayId, entryId) {
            if (!currentUserId || !dayId || !entryId) return;
            
            const dayRef = getPatientDiaryDayRef(currentUserId, dayId);
            try {
                const dayDoc = await getDoc(dayRef);
                if (!dayDoc.exists()) return;

                const dayData = dayDoc.data();
                const currentEntries = dayData.entries || [];
                
                // Filtra o array, removendo o item com o ID correspondente
                const newEntries = currentEntries.filter(entry => entry.id !== entryId);
                
                await setDoc(dayRef, { entries: newEntries }, { merge: true });
                console.log("Entrada removida!");
            } catch (error) {
                console.error("Erro ao remover entrada: ", error);
                alert("Erro ao apagar. Tente novamente.");
            }
        }
        
        /** Apaga um registro de SAÍDA */
        async function deleteExit(dayId, exitId) {
            if (!currentUserId || !dayId || !exitId) return;
            
            const dayRef = getPatientDiaryDayRef(currentUserId, dayId);
            try {
                const dayDoc = await getDoc(dayRef);
                if (!dayDoc.exists()) return;

                const dayData = dayDoc.data();
                const currentExits = dayData.exits || [];
                
                const newExits = currentExits.filter(exit => exit.id !== exitId);
                
                await setDoc(dayRef, { exits: newExits }, { merge: true });
                console.log("Saída removida!");
            } catch (error) {
                console.error("Erro ao remover saída: ", error);
                alert("Erro ao apagar. Tente novamente.");
            }
        }

        /** Verifica se o paciente já tem cadastro */
        async function checkPatientData(userId) {
            const profileRef = getPatientProfileRef(userId);
            try {
                const docSnap = await getDoc(profileRef);
                
                if (docSnap.exists()) {
                    // Paciente cadastrado, mostrar diário
                    const data = docSnap.data();
                    document.getElementById('patient-name-display').textContent = data.nome;
                    showPatientView('diary');
                    // Inicia o listener para o diário
                    listenToPatientDiary(userId);
                } else {
                    // Paciente não cadastrado, mostrar formulário
                    showPatientView('registration');
                }
            } catch (error) {
                console.error("Erro ao verificar dados do paciente: ", error);
                showPatientView('registration'); // Assume que não tem cadastro se der erro
            }
        }


        // --- Funções do Firebase (Profissional) ---

        /** Busca paciente pelo prontuário (lê o índice) */
        async function findPatientByProntuario(prontuario) {
            const sanitizedProntuario = sanitizeInput(prontuario);
            if (!sanitizedProntuario) {
                showSearchError("Por favor, digite um número de prontuário.");
                return;
            }

            const indexDocRef = doc(db, `artifacts/${appId}/public/data/patientIndex/${sanitizedProntuario}`);
            
            try {
                const docSnap = await getDoc(indexDocRef);
                
                if (docSnap.exists()) {
                    const indexData = docSnap.data();
                    const patientUserId = indexData.patientUserId;
                    // Encontrou! Agora busca os dados reais (perfil e diário)
                    loadPatientDataForProf(patientUserId);
                    showSearchError(""); // Limpa erros
                    document.getElementById('patient-data-view').classList.remove('hidden');
                } else {
                    // Não encontrou no índice
                    showSearchError("Prontuário não encontrado.");
                    clearProfPatientView();
                }
            } catch (error) {
                console.error("Erro ao buscar prontuário: ", error);
                showSearchError("Erro ao buscar. Tente novamente.");
                clearProfPatientView();
            }
        }
        
        /** Limpa a visão de dados do paciente (visão prof) */
        function clearProfPatientView() {
            document.getElementById('patient-data-view').classList.add('hidden');
            document.getElementById('view-patient-name').textContent = '';
            document.getElementById('view-patient-idade').textContent = '';
            document.getElementById('view-patient-prontuario').textContent = '';
            document.getElementById('view-patient-medicamentos').textContent = '';
            document.getElementById('prof-diary-days-list').innerHTML = '';
            
            // Para de ouvir os dados do paciente anterior
            if (currentPatientDataUnsubscribe) currentPatientDataUnsubscribe();
            if (currentPatientDiaryUnsubscribe) currentPatientDiaryUnsubscribe();
            
            currentPatientData = null;
            currentPatientDiary = null;
        }
        
        /** Mostra/esconde mensagem de erro na busca */
        function showSearchError(message) {
            const errorEl = document.getElementById('search-error');
            if (message) {
                errorEl.textContent = message;
                errorEl.classList.remove('hidden');
            } else {
                errorEl.classList.add('hidden');
            }
        }

        /** Carrega e ouve os dados de um paciente (visão do profissional) */
        function loadPatientDataForProf(patientUserId) {
            // Para de ouvir o paciente anterior, se houver
            if (currentPatientDataUnsubscribe) currentPatientDataUnsubscribe();
            if (currentPatientDiaryUnsubscribe) currentPatientDiaryUnsubscribe();
            
            // 1. Ouve os dados do Perfil
            const profileRef = getPatientProfileRef(patientUserId);
            currentPatientDataUnsubscribe = onSnapshot(profileRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentPatientData = data; // Armazena globalmente
                    document.getElementById('view-patient-name').textContent = data.nome;
                    document.getElementById('view-patient-idade').textContent = data.idade;
                    document.getElementById('view-patient-prontuario').textContent = data.prontuario;
                    document.getElementById('view-patient-medicamentos').textContent = data.medicamentos || 'N/A';
                } else {
                    showSearchError("Erro: Perfil do paciente não encontrado.");
                    clearProfPatientView();
                }
            }, (error) => {
                console.error("Erro ao carregar perfil do paciente: ", error);
                showSearchError("Erro ao carregar dados do paciente.");
            });

            // 2. Ouve os dados do Diário
            const diaryRef = getPatientDiaryCollectionRef(patientUserId);
            const q = query(diaryRef); // TODO: Adicionar orderBy
            
            currentPatientDiaryUnsubscribe = onSnapshot(q, (snapshot) => {
                const days = [];
                snapshot.forEach(doc => {
                    days.push({ id: doc.id, ...doc.data() });
                });
                
                // Ordena os dias (mais recente primeiro)
                days.sort((a, b) => b.dayDate.toDate() - a.dayDate.toDate());
                
                currentPatientDiary = days; // Armazena globalmente
                
                const listEl = document.getElementById('prof-diary-days-list');
                if (days.length === 0) {
                    listEl.innerHTML = `<p class="text-gray-500 text-center">Paciente sem registros no diário.</p>`;
                } else {
                    listEl.innerHTML = days.map(day => createDayCardHTML(day, true)).join('');
                }
            }, (error) => {
                console.error("Erro ao carregar diário do paciente: ", error);
            });
        }
        
        // --- Funções de Exportação (PDF) ---
        
        /** * Gera o conteúdo do PDF.
         * @param {object} patient - Os dados cadastrais do paciente.
         * @param {Array} days - A lista de dias (objetos) para incluir.
         */
        function generatePDF(patient, days) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Título
            doc.setFontSize(18);
            doc.text("Diário Miccional Digital", 14, 22);
            doc.setFontSize(11);
            doc.setTextColor(100);

            // Dados do Paciente
            doc.setFontSize(12);
            doc.text("Dados do Paciente", 14, 35);
            doc.setFontSize(10);
            doc.text(`Nome: ${patient.nome}`, 14, 42);
            doc.text(`Prontuário: ${patient.prontuario}`, 14, 48);
            doc.text(`Idade: ${patient.idade}`, 100, 48);
            
            const meds = doc.splitTextToSize(`Medicamentos: ${patient.medicamentos || 'N/A'}`, 180);
            doc.text(meds, 14, 54);
            
            let y = doc.autoTable.previous.finalY || 70; // Posição Y inicial

            // Itera sobre cada dia
            days.forEach((day, index) => {
                if (index > 0) {
                    doc.addPage(); // Adiciona nova página para dias seguintes
                    y = 20; // Reseta Y
                }

                const dayDateStr = formatDate(day.dayDate.toDate());
                doc.setFontSize(14);
                doc.text(`Dia: ${dayDateStr}`, 14, y);
                y += 8;

                // --- Balanço ---
                const { totalEntries, totalExits, balance, nightVolume } = calculateDailySummary(day);
                doc.setFontSize(10);
                doc.text(`Balanço: ${balance}ml (Entradas: ${totalEntries}ml / Saídas: ${totalExits}ml)`, 14, y);
                y += 6;
                doc.text(`Volume Noturno (22h-06h): ${nightVolume}ml`, 14, y);
                y += 10;

                // --- Tabelas de Entradas e Saídas ---
                const entries = day.entries || [];
                const exits = day.exits || [];

                // Tabela de Entradas
                if (entries.length > 0) {
                    doc.setFontSize(12);
                    doc.text("Entradas", 14, y);
                    y += 6;
                    doc.autoTable({
                        startY: y,
                        head: [['Hora', 'Tipo', 'Detalhes']],
                        body: entries.sort((a, b) => a.timestamp.toDate() - b.timestamp.toDate())
                            .map(e => [
                                formatTime(e.timestamp.toDate()),
                                e.type === 'liquido' ? 'Líquido' : 'Fruta',
                                e.type === 'liquido' ? `${e.volume}ml` : e.fruitName
                            ]),
                        theme: 'grid'
                    });
                    y = doc.autoTable.previous.finalY + 10;
                } else {
                    doc.setFontSize(10);
                    doc.text("Nenhum registro de entrada.", 14, y);
                    y += 10;
                }

                // Tabela de Saídas
                if (exits.length > 0) {
                    doc.setFontSize(12);
                    doc.text("Saídas (Micção)", 14, y);
                    y += 6;
                    doc.autoTable({
                        startY: y,
                        head: [['Hora', 'Volume', 'Local', 'Residual (ml)']],
                        body: exits.sort((a, b) => a.timestamp.toDate() - b.timestamp.toDate())
                            .map(e => [
                                formatTime(e.timestamp.toDate()),
                                formatExitVolume(e),
                                e.location || 'N/A',
                                e.residualVolume || 0
                            ]),
                        theme: 'grid',
                        didParseCell: (data) => {
                            // Destaca células de residual alto
                            if (data.column.index === 3) {
                                const residual = data.cell.raw;
                                const highlight = getHighlightClass(residual);
                                if (highlight === 'highlight-red') {
                                    data.cell.styles.fillColor = [254, 226, 226]; // red-100
                                    data.cell.styles.textColor = [153, 27, 27]; // red-800
                                } else if (highlight === 'highlight-yellow') {
                                    data.cell.styles.fillColor = [254, 249, 195]; // yellow-100
                                    data.cell.styles.textColor = [113, 63, 18]; // yellow-800
                                }
                            }
                        }
                    });
                    y = doc.autoTable.previous.finalY + 10;
                } else {
                    doc.setFontSize(10);
                    doc.text("Nenhum registro de saída.", 14, y);
                    y += 10;
                }
            });

            // Salva o PDF
            doc.save(`Diario_${patient.prontuario}_${patient.nome}.pdf`);
        }


        // --- Auth e Inicialização ---

        /** Trata o estado da autenticação (logado, deslogado, etc) */
        function handleAuthState(user) {
            if (user) {
                // Usuário está logado
                currentUserId = user.uid;
                
                if (user.isAnonymous) {
                    // É um paciente (anônimo)
                    checkPatientData(user.uid);
                } else {
                    // É um profissional (e-mail/senha)
                    document.getElementById('prof-email-display').textContent = user.email;
                    showProfView('dashboard');
                }
            } else {
                // Usuário deslogado
                currentUserId = null;
                // Para todos os listeners
                if (currentPatientDiaryUnsubscribe) currentPatientDiaryUnsubscribe();
                if (currentPatientDataUnsubscribe) currentPatientDataUnsubscribe();
                
                showScreen('home');
            }
        }
        
        /** Inicializa a Animação Lottie */
        function initLottie() {
            try {
                // REMOVIDO: O JSON de 'animationData' estava a causar um SyntaxError.
                // Foi substituído por uma mensagem de texto simples.
                // A biblioteca Lottie (lottie.min.js) ainda é carregada, mas não é
                // usada aqui para evitar o erro de 'parsing'.
                lottieLoading.innerHTML = '<p class="text-gray-400">(Carregando...)</p>';
                
            } catch (e) {
                console.warn("Lottie não carregou ou não foi necessário.", e);
                lottieLoading.innerHTML = '<p class="text-gray-400">(Carregando...)</p>';
            }
        }

        /** Inicializa a aplicação */
        async function initApp() {
            initLottie();
            
            try {
                // Verifica se as chaves foram preenchidas
                if (firebaseConfig.apiKey === "COLE_SUA_API_KEY_AQUI") {
                    showScreen('loading'); // Fica travado no loading
                    lottieLoading.innerHTML = '<p class="text-red-500 font-bold p-4 text-center">ERRO: As chaves do Firebase não foram configuradas no `index.html` (linha 350).</p>';
                    return;
                }

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Ouve mudanças no estado de autenticação
                onAuthStateChanged(auth, handleAuthState);
            } catch (error) {
                console.error("Erro ao inicializar Firebase: ", error);
                showScreen('loading');
                lottieLoading.innerHTML = '<p class="text-red-500 font-bold p-4 text-center">ERRO: Falha ao inicializar o Firebase. Verifique suas chaves e a conexão com a internet.</p>';
            }
        }


        // --- Event Listeners Globais ---
        
        // --- Navegação Home ---
        document.getElementById('btn-go-patient').addEventListener('click', async () => {
            try {
                // Faz login anônimo para o paciente
                await signInAnonymously(auth);
                // O onAuthStateChanged vai lidar com a mudança de tela
            } catch (error) {
                console.error("Erro no login anônimo: ", error);
                alert("Não foi possível acessar a área do paciente. Tente novamente.");
            }
        });

        document.getElementById('btn-go-professional').addEventListener('click', () => {
            showProfView('login');
        });
        
        document.getElementById('btn-prof-back-home').addEventListener('click', () => {
            showScreen('home');
        });

        // --- Cadastro Paciente ---
        document.getElementById('form-patient-register').addEventListener('submit', (e) => {
            e.preventDefault();
            const prontuario = document.getElementById('reg-prontuario');
            const nome = document.getElementById('reg-nome');
            const idade = document.getElementById('reg-idade');
            const medicamentos = document.getElementById('reg-medicamentos');
            
            // Validação
            const v1 = validateField(prontuario);
            const v2 = validateField(nome);
            const v3 = validateField(idade);

            if (v1 && v2 && v3) {
                // Sanitiza o campo opcional também
                const sanitizedMeds = sanitizeInput(medicamentos.value);
                
                showConfirmationModal(
                    "Confirmar Cadastro",
                    "Os dados estão corretos? Você não poderá alterar o número do prontuário depois.",
                    "Sim, salvar",
                    () => {
                        registerPatient(prontuario.value, nome.value, idade.value, sanitizedMeds);
                    }
                );
            }
        });

        // --- Diário Paciente ---
        document.getElementById('btn-add-new-day').addEventListener('click', addNewDay);

        // --- Login Profissional ---
        document.getElementById('form-prof-login').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = sanitizeInput(document.getElementById('prof-email').value);
            const password = document.getElementById('prof-password').value; // Senha não é sanitizada
            const errorEl = document.getElementById('prof-login-error');
            const submitBtn = document.getElementById('btn-prof-login-submit');

            submitBtn.disabled = true;
            submitBtn.textContent = "Entrando...";
            errorEl.classList.add('hidden');

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // Sucesso! O onAuthStateChanged vai lidar com a tela
            } catch (error) {
                console.error("Erro de login: ", error.code);
                let message = "Erro ao fazer login. Tente novamente.";
                if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                    message = "Email ou senha incorretos.";
                }
                errorEl.textContent = message;
                errorEl.classList.remove('hidden');
                
                // Atraso de segurança contra brute force
                setTimeout(() => {
                    submitBtn.disabled = false;
                    submitBtn.textContent = "Entrar";
                }, 2000); // Atraso de 2 segundos
            }
        });
        
        document.getElementById('btn-prof-logout').addEventListener('click', async () => {
            await signOut(auth);
            clearProfPatientView();
            // O onAuthStateChanged vai para a tela home
        });

        // --- Painel Profissional (Busca) ---
        document.getElementById('btn-search-prontuario').addEventListener('click', () => {
            const prontuario = document.getElementById('search-prontuario').value;
            findPatientByProntuario(prontuario);
        });
        document.getElementById('search-prontuario').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                findPatientByProntuario(e.target.value);
            }
        });
        
        // --- Painel Profissional (Exportação) ---
        document.getElementById('btn-export-all-prof').addEventListener('click', () => {
            if (currentPatientData && currentPatientDiary) {
                if (currentPatientDiary.length === 0) {
                    alert("Este paciente não possui registros no diário para exportar.");
                    return;
                }
                generatePDF(currentPatientData, currentPatientDiary);
            } else {
                alert("Erro: Dados do paciente não carregados.");
            }
        });

        // --- Listeners Dinâmicos (delegados ao container da app) ---
        document.getElementById('app-container').addEventListener('click', (e) => {
            
            // --- Modais de Adição (Paciente) ---
            if (e.target.classList.contains('btn-add-entry')) {
                currentDayId = e.target.dataset.dayId; // Armazena o dia
                showAddEntryModal();
            }
            if (e.target.classList.contains('btn-add-exit')) {
                currentDayId = e.target.dataset.dayId; // Armazena o dia
                showAddExitModal();
            }
            
            // --- Modais de Remoção (Paciente) ---
            if (e.target.classList.contains('btn-delete-entry')) {
                const dayId = e.target.dataset.dayId;
                const entryId = e.target.dataset.entryId;
                showConfirmationModal(
                    "Apagar Registro",
                    "Tem certeza que deseja apagar esta entrada?",
                    "Sim, apagar",
                    () => deleteEntry(dayId, entryId)
                );
            }
            if (e.target.classList.contains('btn-delete-exit')) {
                const dayId = e.target.dataset.dayId;
                const exitId = e.target.dataset.exitId;
                showConfirmationModal(
                    "Apagar Registro",
                    "Tem certeza que deseja apagar esta saída?",
                    "Sim, apagar",
                    () => deleteExit(dayId, exitId)
                );
            }
            
            // --- Exportação por Dia (Profissional) ---
            if (e.target.classList.contains('btn-export-day-prof')) {
                const dayId = e.target.dataset.dayId;
                const day = currentPatientDiary.find(d => d.id === dayId);
                if (day && currentPatientData) {
                    generatePDF(currentPatientData, [day]);
                }
            }
        });

        // --- Listeners do Modal (para salvar e cancelar) ---
        modal.container.addEventListener('click', (e) => {
            // Clicar fora do modal (no fundo escuro) fecha ele
            if (e.target.id === 'modal-container') {
                hideModal();
            }
            // Botão de cancelar genérico
            if (e.target.id === 'btn-modal-cancel') {
                hideModal();
            }
        });
        
        modal.content.addEventListener('submit', (e) => {
            e.preventDefault();
            
            // --- Salvar Entrada ---
            if (e.target.id === 'form-add-entry') {
                const timestamp = parseDateTime(
                    document.getElementById('entry-date').value,
                    document.getElementById('entry-time').value
                );
                const type = document.querySelector('input[name="entry-type"]:checked').value;
                
                let data = { timestamp };
                let isValid = false;

                if (type === 'liquido') {
                    const volumeEl = document.getElementById('entry-volume');
                    if (validateField(volumeEl)) {
                        data = { ...data, type, volume: volumeEl.value };
                        isValid = true;
                    }
                } else {
                    const frutaEl = document.getElementById('entry-fruta');
                    if (validateField(frutaEl)) {
                        data = { ...data, type, fruitName: frutaEl.value };
                        isValid = true;
                    }
                }
                
                if (isValid) {
                    addEntryToDay(currentDayId, data);
                }
            }

            // --- Salvar Saída ---
            if (e.target.id === 'form-add-exit') {
                const timestamp = parseDateTime(
                    document.getElementById('exit-date').value,
                    document.getElementById('exit-time').value
                );
                const type = document.querySelector('input[name="exit-type"]:checked').value;
                const location = sanitizeInput(document.getElementById('exit-location').value);
                const residualVolume = sanitizeInput(document.getElementById('exit-residual').value) || 0;
                
                let data = { timestamp, location, residualVolume: Number(residualVolume) };
                let isValid = false;
                
                if (type === 'quantificavel') {
                    const volumeEl = document.getElementById('exit-volume');
                    if (validateField(volumeEl)) {
                        data = { ...data, type, volume: volumeEl.value };
                        isValid = true;
                    }
                } else {
                    const intensityEl = document.getElementById('exit-intensity');
                    if (validateField(intensityEl)) {
                        data = { ...data, type, intensity: intensityEl.value };
                        isValid = true;
                    }
                }
                
                if (isValid) {
                    addExitToDay(currentDayId, data);
                }
            }
        });

        // Inicia a aplicação
        document.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>
</html>




